<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Há»c Tiáº¿ng Nháº­t cÃ¹ng Rem - BÃ i 1 (Chuáº©n PDF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Quicksand:wght@500;600;700&display=swap');
        
        body {
            font-family: 'Quicksand', 'Noto Sans JP', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#dbeafe 1px, transparent 1px);
            background-size: 20px 20px;
            overscroll-behavior-y: contain; 
        }

        /* RUBY (FURIGANA) STYLING */
        ruby {
            ruby-position: over;
            display: inline-flex;
            flex-direction: column-reverse;
            align-items: center;
            vertical-align: bottom;
            line-height: 1.5;
        }
        rt {
            font-size: 0.6em;
            color: #64748b;
            font-weight: normal;
            line-height: 1;
            margin-bottom: 0px;
            user-select: none;
        }

        /* 3D Flip Animation */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Rem Avatar */
        .rem-avatar-container {
            position: relative;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            z-index: 50;
        }
        .rem-avatar-container:hover {
            transform: scale(1.05);
        }
        .rem-avatar-container:active {
            transform: scale(0.95);
        }
        .rem-glow {
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.6);
            border-color: #93c5fd;
        }
        .rem-avatar-container.disabled {
            filter: grayscale(0.8) opacity(0.7);
        }
        
        /* Camera Icon Overlay on Hover */
        .rem-avatar-container .upload-overlay {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .rem-avatar-container:hover .upload-overlay {
            opacity: 1;
        }

        /* Advanced Rem Chat Bubble */
        .rem-bubble-wrapper {
            position: absolute;
            top: 5px;
            left: 75px;
            z-index: 40;
            pointer-events: none;
            filter: drop-shadow(0 4px 6px rgba(37, 99, 235, 0.15));
        }

        .rem-bubble {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            border: 1px solid #bfdbfe;
            border-radius: 18px;
            border-top-left-radius: 2px;
            padding: 12px 20px;
            min-width: 240px;
            max-width: 340px;
            opacity: 0;
            transform-origin: top left;
            transform: scale(0) rotate(-10deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .rem-bubble.show {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            animation: floatBubble 3s ease-in-out infinite;
        }

        @keyframes floatBubble {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .rem-text-main {
            font-size: 0.95rem;
            color: #1e3a8a;
            font-weight: 700;
            line-height: 1.4;
        }
        
        .rem-text-sub {
            font-size: 0.8rem;
            color: #3b82f6;
            font-weight: 600;
            border-top: 1px solid #e0f2fe;
            padding-top: 4px;
            margin-top: 2px;
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* Typewriter Cursor */
        .cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: #3b82f6;
            margin-left: 2px;
            animation: blink 1s step-end infinite;
            vertical-align: middle;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Mobile adjustment */
        @media (max-width: 640px) {
            .rem-bubble-wrapper {
                top: 65px;
                left: 10px;
            }
            .rem-bubble {
                border-top-left-radius: 18px;
                border-top-right-radius: 2px;
            }
        }

        .match-card {
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        .match-card.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
            transform: scale(1.05);
            box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.4);
        }
        .match-card.matched {
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }
        .match-card.wrong {
            background-color: #ef4444;
            color: white;
            animation: shake 0.4s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .input-focus-ring:focus-within {
            box-shadow: 0 0 0 4px rgba(147, 197, 253, 0.5);
            border-color: #60a5fa;
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col pb-20">

    <!-- HEADER -->
    <header class="bg-white/80 backdrop-blur-md border-b border-blue-100 sticky top-0 z-30 shadow-sm select-none">
        <div class="max-w-5xl mx-auto px-4 h-20 py-2 flex items-center justify-between relative">
            <div class="flex items-center gap-4 relative">
                <!-- Rem Avatar - CLICK TO CHANGE IMAGE -->
                <div id="rem-avatar-container" class="rem-avatar-container w-16 h-16 rounded-full overflow-hidden border-4 border-white rem-glow bg-blue-50 flex-shrink-0 group" onclick="document.getElementById('avatar-upload').click()" title="Cháº¡m Ä‘á»ƒ Ä‘á»•i áº£nh">
                    <!-- Default Rem Image -->
                    <img id="rem-avatar-img"
                         src="../download.jpg"
                         alt="Rem"
                         class="w-full h-full object-cover">

                    
                    <!-- Overlay Icon -->
                    <div class="upload-overlay absolute inset-0 bg-black/30 flex items-center justify-center">
                        <i class="fas fa-camera text-white text-xl"></i>
                    </div>
                    
                    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="changeAvatar(this)">
                </div>

                <!-- Talk Button (Manual Trigger) -->
                <button onclick="triggerRemTalk()" class="absolute -bottom-2 left-10 bg-blue-500 hover:bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-md z-50 border-2 border-white transition-transform hover:scale-110" title="Rem nÃ³i chuyá»‡n ngay">
                    <i class="fas fa-comment-dots text-xs"></i>
                </button>

                <!-- REM CHAT BUBBLE -->
                <div class="rem-bubble-wrapper">
                    <div id="rem-bubble" class="rem-bubble">
                        <div class="rem-text-main">
                            <span id="typewriter-vi"></span><span class="cursor" id="cursor-vi"></span>
                        </div>
                        <div class="rem-text-sub" id="sub-text-container" style="display: none;">
                            <span id="typewriter-ja"></span>
                        </div>
                    </div>
                </div>

                <div class="ml-2 pt-1 flex flex-col justify-center">
                    <h1 class="text-xl font-bold text-slate-800 hidden sm:block tracking-tight">Há»c cÃ¹ng Rem</h1>
                    <h1 class="text-lg font-bold text-slate-800 sm:hidden">Minna BÃ i 1</h1>
                    
                    <!-- CONTROLS ROW -->
                    <div class="flex items-center gap-3 text-xs font-bold text-slate-500 mt-1">
                        <button onclick="document.getElementById('avatar-upload').click()" class="flex items-center gap-1 hover:text-blue-500 transition-colors">
                            <i class="fas fa-camera"></i> <span class="hidden sm:inline">Äá»•i áº£nh</span>
                        </button>
                        <span class="text-slate-300">|</span>
                        <button onclick="toggleRemChat()" id="btn-toggle-chat" class="flex items-center gap-1 hover:text-blue-500 transition-colors text-blue-500">
                            <i class="fas fa-comment-dots"></i> <span id="chat-status-text">Báº­t Chat</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="hidden sm:flex flex-col items-end">
                <span class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Tiáº¿n Ä‘á»™</span>
                <span class="text-sm font-bold text-blue-600" id="global-progress">0%</span>
            </div>
        </div>

        <!-- TABS NAV -->
        <div class="max-w-5xl mx-auto px-4 overflow-x-auto no-scrollbar bg-white/50 backdrop-blur-sm border-b border-blue-50">
            <div class="flex gap-2 sm:gap-6 border-b border-transparent min-w-max sm:min-w-0" id="tab-container">
                <button onclick="switchTab('flashcard')" class="tab-btn active flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-blue-500 text-blue-600 bg-blue-50/50" data-tab="flashcard">
                    <i class="fas fa-clone"></i> <span class="hidden sm:inline">Flashcard</span><span class="sm:hidden">Tháº»</span>
                </button>
                <button onclick="switchTab('quiz')" class="tab-btn flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-transparent text-gray-500 hover:text-gray-800 hover:bg-white/50" data-tab="quiz">
                    <i class="fas fa-question-circle"></i> <span class="hidden sm:inline">Tráº¯c nghiá»‡m</span><span class="sm:hidden">Quiz</span>
                </button>
                <button onclick="switchTab('write')" class="tab-btn flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-transparent text-gray-500 hover:text-gray-800 hover:bg-white/50" data-tab="write">
                    <i class="fas fa-keyboard"></i> <span class="hidden sm:inline">GÃµ tá»«</span><span class="sm:hidden">GÃµ</span>
                </button>
                <button onclick="switchTab('match')" class="tab-btn flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-transparent text-gray-500 hover:text-gray-800 hover:bg-white/50" data-tab="match">
                    <i class="fas fa-puzzle-piece"></i> <span class="hidden sm:inline">GhÃ©p tháº»</span><span class="sm:hidden">GhÃ©p</span>
                </button>
                <button onclick="switchTab('list')" class="tab-btn flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-transparent text-gray-500 hover:text-gray-800 hover:bg-white/50" data-tab="list">
                    <i class="fas fa-list"></i> <span class="hidden sm:inline">Danh sÃ¡ch</span><span class="sm:hidden">List</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-5xl mx-auto px-4 py-6 w-full flex-grow relative" onclick="resetIdleTimer()">
        
        <!-- 1. FLASHCARD MODE -->
        <div id="view-flashcard" class="view-section fade-in">
            <div class="flex flex-col items-center justify-center max-w-2xl mx-auto">
                <div class="w-full flex justify-between items-center mb-4 px-2">
                    <span class="text-slate-500 font-bold text-sm bg-white px-4 py-1.5 rounded-full shadow-sm border border-blue-100" id="fc-counter">1 / 53</span>
                    <button onclick="toggleShuffle()" id="btn-shuffle" class="flex items-center gap-2 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider transition-all bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-500 shadow-sm">
                        <i class="fas fa-random"></i> <span>Gá»‘c</span>
                    </button>
                </div>

                <div class="relative w-full aspect-[16/10] sm:aspect-[16/9] cursor-pointer perspective-1000 group" onclick="flipCard()">
                    <div id="card-inner" class="relative w-full h-full duration-500 preserve-3d transition-transform">
                        <!-- Front -->
                        <div class="absolute w-full h-full backface-hidden bg-white border border-blue-100 rounded-3xl shadow-[0_10px_40px_-10px_rgba(59,130,246,0.15)] flex flex-col items-center justify-center p-6 text-center hover:shadow-[0_20px_50px_-10px_rgba(59,130,246,0.25)] transition-shadow">
                            <span class="text-xs text-blue-500 font-extrabold tracking-widest uppercase mb-4 bg-blue-50 px-3 py-1 rounded-lg">Tiáº¿ng Nháº­t</span>
                            <div class="flex flex-col items-center justify-center gap-4 mb-2 w-full flex-grow">
                                <h2 class="text-4xl sm:text-6xl font-black text-slate-800 tracking-tight" id="fc-japanese">...</h2>
                                <button onclick="playAudioFromCard(event)" class="w-12 h-12 rounded-full bg-blue-50 text-blue-500 hover:bg-blue-500 hover:text-white transition-all shadow-sm flex items-center justify-center transform hover:scale-110 active:scale-95" title="Nghe phÃ¡t Ã¢m">
                                    <i class="fas fa-volume-up text-lg"></i>
                                </button>
                            </div>
                            <p class="text-xl text-slate-400 font-medium italic mb-8 font-serif" id="fc-romaji">...</p>
                            <div class="absolute bottom-6 text-xs text-blue-300 flex items-center gap-2 font-bold animate-pulse">
                                <i class="fas fa-sync-alt"></i> Cháº¡m Ä‘á»ƒ láº­t
                            </div>
                        </div>

                        <!-- Back -->
                        <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-blue-500 to-indigo-600 rounded-3xl shadow-xl flex flex-col items-center justify-center p-6 text-center rotate-y-180 text-white">
                            <span class="text-xs text-blue-100 font-extrabold tracking-widest uppercase mb-4 bg-white/10 px-3 py-1 rounded-lg backdrop-blur-sm">Tiáº¿ng Viá»‡t</span>
                            <h2 class="text-2xl sm:text-4xl font-bold leading-relaxed flex-grow flex items-center justify-center drop-shadow-md" id="fc-vietnamese">
                                ...
                            </h2>
                            <button onclick="playAudioFromCard(event)" class="mt-4 px-6 py-2.5 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur-md text-white transition-all flex items-center gap-2 text-sm font-bold shadow-inner">
                                <i class="fas fa-volume-up"></i> Nghe láº¡i
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4 mt-8 w-full max-w-sm">
                    <button onclick="prevCard()" class="flex-1 py-4 rounded-2xl bg-white border border-slate-200 shadow-sm hover:bg-slate-50 hover:border-blue-300 text-slate-600 transition-all active:scale-95 flex items-center justify-center group">
                        <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                    </button>
                    <button onclick="nextCard()" class="flex-1 py-4 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 shadow-lg shadow-blue-200 hover:shadow-blue-300 hover:to-blue-500 text-white transition-all active:scale-95 flex items-center justify-center group font-bold">
                         Tiáº¿p theo <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. QUIZ MODE -->
        <div id="view-quiz" class="view-section hidden fade-in">
            <div id="quiz-container" class="max-w-2xl mx-auto">
                <div id="quiz-config" class="mb-4 flex justify-end">
                    <div class="inline-flex bg-white rounded-xl border border-slate-200 p-1.5 shadow-sm">
                        <select id="quiz-mode-select" onchange="changeQuizMode(this.value)" class="text-xs font-bold text-slate-600 bg-transparent outline-none cursor-pointer py-1 px-2">
                            <option value="ja_to_vi">ğŸ‡¯ğŸ‡µ Nháº­t âœ ğŸ‡»ğŸ‡³ Viá»‡t</option>
                            <option value="vi_to_ja">ğŸ‡»ğŸ‡³ Viá»‡t âœ ğŸ‡¯ğŸ‡µ Nháº­t</option>
                            <option value="mixed">ğŸ”€ Trá»™n láº«n</option>
                        </select>
                    </div>
                </div>

                <div id="quiz-result" class="hidden flex flex-col items-center justify-center py-10 text-center">
                    <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-500 text-5xl mb-6 shadow-inner animate-bounce">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">HoÃ n thÃ nh!</h2>
                    <p class="text-slate-500 mb-6 font-medium">Báº¡n Ä‘Ã£ tráº£ lá»i Ä‘Ãºng:</p>
                    <div class="text-6xl font-black text-blue-600 mb-8 tracking-tighter">
                        <span id="quiz-score">0</span><span class="text-2xl text-slate-300 font-normal mx-2">/</span><span id="quiz-total" class="text-2xl text-slate-400 font-normal">0</span>
                    </div>
                    <button onclick="initQuiz()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 transform hover:-translate-y-1">
                        <i class="fas fa-redo mr-2"></i> Thá»­ láº¡i
                    </button>
                </div>

                <div id="quiz-game">
                    <div class="flex justify-between items-end mb-6">
                        <span class="text-xs font-extrabold text-blue-600 uppercase tracking-wider bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">CÃ¢u há»i <span id="quiz-current-idx">1</span></span>
                        <div class="flex gap-1 h-2.5 w-32 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                            <div id="quiz-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-3xl shadow-lg border border-slate-100 mb-6 text-center relative overflow-hidden min-h-[180px] flex flex-col items-center justify-center">
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400"></div>
                        <h3 class="text-3xl md:text-5xl font-black text-slate-800 mb-3" id="quiz-question-main">...</h3>
                        <p class="text-slate-400 font-medium italic mb-2" id="quiz-question-sub">...</p>
                        <button id="quiz-audio-btn" onclick="playAudioCurrentQuiz()" class="mx-auto w-10 h-10 rounded-full bg-slate-50 text-slate-400 hover:bg-blue-100 hover:text-blue-600 transition-all flex items-center justify-center hidden mt-2">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-3" id="quiz-options">
                        <!-- Options injected via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. WRITE MODE -->
        <div id="view-write" class="view-section hidden fade-in">
            <div class="max-w-xl mx-auto mt-4">
                <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-slate-100 text-center relative">
                    <div class="flex justify-between items-center mb-8">
                         <div class="inline-flex bg-slate-50 p-1.5 rounded-xl border border-slate-100">
                            <select id="write-direction" onchange="setWriteDirection(this.value)" class="text-xs font-bold text-slate-600 bg-transparent outline-none cursor-pointer py-1 px-2">
                                <option value="vi_to_ja">ğŸ‡»ğŸ‡³ Viá»‡t âœ ğŸ‡¯ğŸ‡µ Nháº­t</option>
                                <option value="ja_to_vi">ğŸ‡¯ğŸ‡µ Nháº­t âœ ğŸ‡»ğŸ‡³ Viá»‡t</option>
                                <option value="mixed">ğŸ”€ Trá»™n láº«n</option>
                            </select>
                        </div>
                        <div id="write-input-type-selector" class="flex bg-slate-50 p-1 rounded-xl border border-slate-100">
                            <button onclick="setWriteInputType('romaji')" id="mode-romaji" class="px-3 py-1 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm border border-slate-100">Romaji</button>
                            <button onclick="setWriteInputType('japanese')" id="mode-japanese" class="px-3 py-1 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600">Kana</button>
                        </div>
                    </div>

                    <div class="mb-8">
                        <p class="text-xs text-blue-400 font-extrabold tracking-widest uppercase mb-3" id="write-label">Dá»‹ch sang tiáº¿ng Nháº­t</p>
                        <h3 class="text-3xl md:text-4xl font-black text-slate-800" id="write-question">...</h3>
                        <div id="write-hint" class="h-10 mt-3 text-blue-500 font-bold opacity-0 transition-opacity flex items-center justify-center text-xl">...</div>
                    </div>

                    <div class="relative group input-focus-ring rounded-2xl mb-4">
                        <input type="text" id="write-input" 
                            class="w-full p-5 text-xl font-bold text-center bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:bg-white transition-all placeholder-slate-300 text-slate-700" 
                            placeholder="Nháº­p cÃ¢u tráº£ lá»i..." autocomplete="off">
                        <button onclick="toggleHint()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-yellow-400 transition-colors" title="Xem gá»£i Ã½">
                            <i class="fas fa-lightbulb"></i>
                        </button>
                    </div>

                    <div id="write-feedback" class="min-h-[4rem] flex items-center justify-center text-sm md:text-base mb-2"></div>

                    <button id="write-btn" onclick="checkWriteAnswer()" class="w-full mt-2 py-4 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all transform active:scale-[0.98]">
                        Kiá»ƒm tra (Enter)
                    </button>
                    
                    <p class="mt-6 text-xs text-slate-400 font-medium bg-slate-50 inline-block px-3 py-1 rounded-full border border-slate-100" id="write-tip">
                        <i class="fas fa-info-circle mr-1 text-blue-400"></i> Máº¹o: GÃµ <span class="font-mono text-slate-600">aa</span> thay <span class="font-mono text-slate-600">Ä</span>, <span class="font-mono text-slate-600">ou</span> thay <span class="font-mono text-slate-600">Å</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- 4. MATCH GAME MODE -->
        <div id="view-match" class="view-section hidden fade-in h-full flex flex-col">
            <div class="max-w-4xl mx-auto w-full h-full flex flex-col">
                <div class="flex justify-between items-center mb-6 px-2">
                    <div class="flex items-center gap-3 text-slate-700 font-bold bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm">
                        <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-500">
                            <i class="fas fa-stopwatch"></i>
                        </div>
                        <span id="match-timer" class="font-mono text-lg">00:00</span>
                    </div>
                    <button onclick="initMatchGame()" class="text-sm font-bold text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-xl transition-colors border border-transparent hover:border-blue-100">
                        <i class="fas fa-redo mr-1"></i> ChÆ¡i láº¡i
                    </button>
                </div>
                
                <div id="match-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 pb-8"></div>
            </div>
        </div>

        <!-- 5. LIST MODE -->
        <div id="view-list" class="view-section hidden fade-in">
            <div class="max-w-4xl mx-auto mt-4 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="p-4 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-1/4">Romaji</th>
                                <th class="p-4 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-1/4">Tiáº¿ng Nháº­t</th>
                                <th class="p-4 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-1/2">NghÄ©a tiáº¿ng Viá»‡t</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50 text-sm" id="list-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- JS LOGIC -->
    <script>
        // --- DATA (UPDATED BASED ON PDF CONTENT) ---
        const vocabularyData = [
            { id: 1, japanese: 'ã‚ãŸã—', reading: 'ã‚ãŸã—', romaji: 'watashi', vietnamese: 'TÃ´i' },
            { id: 2, japanese: 'ï¼ˆãŠï¼‰ãªã¾ãˆ', reading: 'ï¼ˆãŠï¼‰ãªã¾ãˆ', romaji: '(o)namae', vietnamese: 'TÃªn' },
            { id: 3, japanese: 'ï¼ˆãŠï¼‰ãã«', reading: 'ï¼ˆãŠï¼‰ãã«', romaji: '(o)kuni', vietnamese: 'Äáº¥t nÆ°á»›c' },
            { id: 4, japanese: 'ã«ã»ã‚“', reading: 'ã«ã»ã‚“', romaji: 'nihon', vietnamese: 'Nháº­t Báº£n' },
            { id: 5, japanese: 'ã‚¢ãƒ¡ãƒªã‚«', reading: 'ã‚¢ãƒ¡ãƒªã‚«', romaji: 'amerika', vietnamese: 'Má»¹' },
            { id: 6, japanese: 'ã‚¤ã‚¿ãƒªã‚¢', reading: 'ã‚¤ã‚¿ãƒªã‚¢', romaji: 'itaria', vietnamese: 'Ã' },
            { id: 7, japanese: 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢', reading: 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢', romaji: 'Åsutoraria', vietnamese: 'Ãšc' },
            { id: 8, japanese: 'ã‹ã‚“ã“ã', reading: 'ã‹ã‚“ã“ã', romaji: 'kankoku', vietnamese: 'HÃ n Quá»‘c' },
            { id: 9, japanese: 'ã‚¿ã‚¤', reading: 'ã‚¿ã‚¤', romaji: 'tai', vietnamese: 'ThÃ¡i Lan' },
            { id: 10, japanese: 'ã¡ã‚…ã†ã”ã', reading: 'ã¡ã‚…ã†ã”ã', romaji: 'chÅ«goku', vietnamese: 'Trung Quá»‘c' },
            { id: 11, japanese: 'ãƒ­ã‚·ã‚¢', reading: 'ãƒ­ã‚·ã‚¢', romaji: 'roshia', vietnamese: 'Nga' },
            { id: 12, japanese: 'ã“ã†ã“ã†', reading: 'ã“ã†ã“ã†', romaji: 'kÅkÅ', vietnamese: 'TrÆ°á»ng THPT' },
            { id: 13, japanese: 'ã ã„ãŒã', reading: 'ã ã„ãŒã', romaji: 'daigaku', vietnamese: 'Äáº¡i há»c' },
            { id: 14, japanese: 'ã«ã»ã‚“ã”', reading: 'ã«ã»ã‚“ã”', romaji: 'nihongo', vietnamese: 'Tiáº¿ng Nháº­t' },
            { id: 15, japanese: 'ï¼ˆãŠï¼‰ã—ã”ã¨', reading: 'ï¼ˆãŠï¼‰ã—ã”ã¨', romaji: '(o)shigoto', vietnamese: 'CÃ´ng viá»‡c' },
            { id: 16, japanese: 'ãŒãã›ã„', reading: 'ãŒãã›ã„', romaji: 'gakusei', vietnamese: 'Há»c sinh' },
            { id: 17, japanese: 'ã›ã‚“ã›ã„', reading: 'ã›ã‚“ã›ã„', romaji: 'sensei', vietnamese: 'GiÃ¡o viÃªn' },
            { id: 18, japanese: 'ãã‚‡ã†ã—', reading: 'ãã‚‡ã†ã—', romaji: 'kyÅshi', vietnamese: 'GiÃ¡o viÃªn (nghá» nghiá»‡p)' },
            { id: 19, japanese: 'ã‹ã„ã—ã‚ƒã„ã‚“', reading: 'ã‹ã„ã—ã‚ƒã„ã‚“', romaji: 'kaishain', vietnamese: 'NhÃ¢n viÃªn cÃ´ng ty' },
            { id: 20, japanese: 'ã—ã‚ƒã„ã‚“', reading: 'ã—ã‚ƒã„ã‚“', romaji: 'shain', vietnamese: 'NhÃ¢n viÃªn (cá»§a cÃ´ng ty...)' },
            { id: 21, japanese: 'ï½ã•ã‚“', reading: 'ï½ã•ã‚“', romaji: '~san', vietnamese: 'Anh/chá»‹ ~' },
            { id: 22, japanese: 'ï½ã˜ã‚“', reading: 'ï½ã˜ã‚“', romaji: '~jin', vietnamese: 'NgÆ°á»i ~' },
            { id: 23, japanese: 'ã©ã¡ã‚‰', reading: 'ã©ã¡ã‚‰', romaji: 'dochira', vietnamese: 'ÄÃ¢u, nÆ°á»›c nÃ o' },
            { id: 24, japanese: 'ãŠ<ruby>å›½<rt>ãã«</rt></ruby>ã¯ã©ã¡ã‚‰ã§ã™ã‹ã€‚', reading: 'ãŠãã«ã¯ã©ã¡ã‚‰ã§ã™ã‹', romaji: 'okuni wa dochira desu ka', vietnamese: 'Báº¡n lÃ  ngÆ°á»i nÆ°á»›c nÃ o?' },
            { id: 25, japanese: 'ã¯ã˜ã‚ã¾ã—ã¦', reading: 'ã¯ã˜ã‚ã¾ã—ã¦', romaji: 'hajimemashite', vietnamese: 'Ráº¥t hÃ¢n háº¡nh' },
            { id: 26, japanese: 'ï¼ˆã©ã†ãï¼‰ã‚ˆã‚ã—ããŠ<ruby>é¡˜<rt>ã­ãŒ</rt></ruby>ã„ã—ã¾ã™ã€‚', reading: 'ï¼ˆã©ã†ãï¼‰ã‚ˆã‚ã—ããŠã­ãŒã„ã—ã¾ã™', romaji: '(dÅzo) yoroshiku onegaishimasu', vietnamese: 'Mong Ä‘Æ°á»£c giÃºp Ä‘á»¡' },
            { id: 27, japanese: 'ã“ã¡ã‚‰ã“ã', reading: 'ã“ã¡ã‚‰ã“ã', romaji: 'kochira koso', vietnamese: 'ChÃ­nh tÃ´i cÅ©ng váº­y' },
            { id: 28, japanese: 'ã‚ã®ã†', reading: 'ã‚ã®ã†', romaji: 'anÅ', vietnamese: 'Ã€...' },
            { id: 29, japanese: 'ã™ã¿ã¾ã›ã‚“', reading: 'ã™ã¿ã¾ã›ã‚“', romaji: 'sumimasen', vietnamese: 'Xin lá»—i' },
            { id: 30, japanese: 'ã‚ã®ã†ã€ã™ã¿ã¾ã›ã‚“ã€‚', reading: 'ã‚ã®ã†ã€ã™ã¿ã¾ã›ã‚“', romaji: 'anÅ, sumimasen', vietnamese: 'Ã€, xin lá»—i.' },
            { id: 31, japanese: 'ãã†ã§ã™ã‹', reading: 'ãã†ã§ã™ã‹', romaji: 'sÅ desu ka', vietnamese: 'Tháº¿ Ã ' },
            { id: 32, japanese: 'ã¯ã„', reading: 'ã¯ã„', romaji: 'hai', vietnamese: 'VÃ¢ng' },
            { id: 33, japanese: 'ã„ã„ãˆ', reading: 'ã„ã„ãˆ', romaji: 'iie', vietnamese: 'KhÃ´ng' },
            { id: 34, japanese: 'ãŸã‚“ã˜ã‚‡ã†ã³', reading: 'ãŸã‚“ã˜ã‚‡ã†ã³', romaji: 'tanjÅbi', vietnamese: 'Sinh nháº­t' },
            { id: 35, japanese: 'ãƒ–ãƒ©ã‚¸ãƒ«', reading: 'ãƒ–ãƒ©ã‚¸ãƒ«', romaji: 'burajiru', vietnamese: 'Brazil' },
            { id: 36, japanese: 'ï½ãŒã¤', reading: 'ï½ãŒã¤', romaji: '~gatsu', vietnamese: 'ThÃ¡ng ~' },
            { id: 37, japanese: 'ï½ã«ã¡', reading: 'ï½ã«ã¡', romaji: '~nichi', vietnamese: 'NgÃ y ~' },
            { id: 38, japanese: 'ï½ã•ã„', reading: 'ï½ã•ã„', romaji: '~sai', vietnamese: '~ tuá»•i' },
            { id: 39, japanese: 'ã„ã¤', reading: 'ã„ã¤', romaji: 'itsu', vietnamese: 'Khi nÃ o' },
            { id: 40, japanese: 'ã—ã‚…ã¿', reading: 'ã—ã‚…ã¿', romaji: 'shumi', vietnamese: 'Sá»Ÿ thÃ­ch' },
            { id: 41, japanese: 'ã‚¹ãƒãƒ¼ãƒ„', reading: 'ã‚¹ãƒãƒ¼ãƒ„', romaji: 'supÅtsu', vietnamese: 'Thá»ƒ thao' },
            { id: 42, japanese: 'ãƒ†ãƒ‹ã‚¹', reading: 'ãƒ†ãƒ‹ã‚¹', romaji: 'tenisu', vietnamese: 'Tennis' },
            { id: 43, japanese: 'ã™ã„ãˆã„', reading: 'ã™ã„ãˆã„', romaji: 'suiei', vietnamese: 'BÆ¡i lá»™i' },
            { id: 44, japanese: 'ãˆã„ãŒ', reading: 'ãˆã„ãŒ', romaji: 'eiga', vietnamese: 'Phim' },
            { id: 45, japanese: 'ãŠã‚“ãŒã', reading: 'ãŠã‚“ãŒã', romaji: 'ongaku', vietnamese: 'Ã‚m nháº¡c' },
            { id: 46, japanese: 'ã©ãã—ã‚‡', reading: 'ã©ãã—ã‚‡', romaji: 'dokusho', vietnamese: 'Äá»c sÃ¡ch' },
            { id: 47, japanese: 'ã‚Šã‚‡ã“ã†', reading: 'ã‚Šã‚‡ã“ã†', romaji: 'ryokÅ', vietnamese: 'Du lá»‹ch' },
            { id: 48, japanese: 'ã‚Šã‚‡ã†ã‚Š', reading: 'ã‚Šã‚‡ã†ã‚Š', romaji: 'ryÅri', vietnamese: 'Náº¥u Äƒn' },
            { id: 49, japanese: '<ruby>ç§<rt>ã‚ãŸã—</rt></ruby>ã®<ruby>è¶£å‘³<rt>ã—ã‚…ã¿</rt></ruby>ã¯<ruby>æ–™ç†<rt>ã‚Šã‚‡ã†ã‚Š</rt></ruby>ã§ã™ã€‚', reading: 'ã‚ãŸã—ã®ã—ã‚…ã¿ã¯ã‚Šã‚‡ã†ã‚Šã§ã™', romaji: 'watashi no shumi wa ryÅri desu', vietnamese: 'Sá»Ÿ thÃ­ch cá»§a tÃ´i lÃ  náº¥u Äƒn.' },
            { id: 50, japanese: 'ãªã‚“ï¼ãªã«', reading: 'ãªã‚“ï¼ãªã«', romaji: 'nan / nani', vietnamese: 'CÃ¡i gÃ¬' },
            { id: 51, japanese: 'ã‚ï¼ˆã£ï¼‰', reading: 'ã‚ï¼ˆã£ï¼‰', romaji: 'a (ttsu)', vietnamese: 'A!' },
            { id: 52, japanese: 'ã‚ã‚', reading: 'ã‚ã‚', romaji: 'wÄ', vietnamese: 'Ã”i / Wow' },
            { id: 53, japanese: 'ãŠãªã˜ã§ã™ã­', reading: 'ãŠãªã˜ã§ã™ã­', romaji: 'onaji desu ne', vietnamese: 'Giá»‘ng nhau nhá»‰.' },
            { id: 54, japanese: 'ã‚ã‚ŠãŒã¨ã†ã€‚', reading: 'ã‚ã‚ŠãŒã¨ã†', romaji: 'arigatÅ', vietnamese: 'Cáº£m Æ¡n.' }
        ];

        // --- GLOBAL UTILS ---
        function getCleanText(html) {
            // Helper to get pure Kanji/Text from Ruby HTML for checking alternative answers
            if(!html) return "";
            if(!html.includes('<ruby>')) return html;
            const tmp = document.createElement("div");
            tmp.innerHTML = html;
            const rts = tmp.querySelectorAll("rt");
            rts.forEach(rt => rt.remove());
            return tmp.textContent;
        }

        function playAudio(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                // Strip ruby tags for reading if passed raw html, though we prefer passing .reading
                let cleanText = text;
                if(text.includes('<ruby>')) {
                    // If HTML, prefer reading, but if not available, try to guess
                    // Here we just assume 'text' passed is simple enough or use regex to remove HTML tags
                    // But actually we are passing .reading now, so this is just fallback
                    cleanText = text.replace(/<[^>]*>/g, '');
                }
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'ja-JP';
                utterance.rate = 1.0; 
                window.speechSynthesis.speak(utterance);
            }
        }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- CHANGE AVATAR ---
        function changeAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('rem-avatar-img').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- REM VOICE & CHAT LOGIC (V13 - Aaron Control) ---
        const remQuotes = {
            welcome: [
                { ja: "Aaron-kun, konnichiwa! Isshoni ganbarimashou!", vi: "Xin chÃ o Aaron! CÃ¹ng cá»‘ gáº¯ng nhÃ©!" },
                { ja: "Rem wa Aaron-kun o matteimashita yo.", vi: "Rem Ä‘Ã£ Ä‘á»£i Aaron Ä‘Ã³!" },
                { ja: "Aaron-kun, junbi wa ii desu ka?", vi: "Aaron Ä‘Ã£ sáºµn sÃ ng chÆ°a?" },
                { ja: "Kyou mo genki desu ne, Aaron-kun!", vi: "HÃ´m nay Aaron cÅ©ng khá»e nhá»‰!" },
                { ja: "Aaron-kun ni oaidekite ureshii desu.", vi: "Ráº¥t vui Ä‘Æ°á»£c gáº·p Aaron." },
                { ja: "Ohayou gozaimasu, Aaron-kun!", vi: "ChÃ o buá»•i sÃ¡ng, Aaron!" },
                { ja: "Konbanwa Aaron-kun, benkyou desu ka?", vi: "ChÃ o buá»•i tá»‘i Aaron, báº¡n há»c bÃ i Ã ?" },
                { ja: "Aaron-kun no tame ni ganbarimasu.", vi: "Rem sáº½ cá»‘ gáº¯ng vÃ¬ Aaron." },
                { ja: "Saa, hajimemashou, Aaron-kun.", vi: "NÃ o, chÃºng ta báº¯t Ä‘áº§u thÃ´i, Aaron." }
            ],
            correct: [
                { ja: "Sugoi desu, Aaron-kun!", vi: "Aaron tuyá»‡t quÃ¡!" },
                { ja: "Sasuga Aaron-kun desu ne!", vi: "Quáº£ lÃ  Aaron!" },
                { ja: "Seikai desu! Aaron-kun wa kashikoi desu.", vi: "ChÃ­nh xÃ¡c! Aaron thÃ´ng minh quÃ¡." },
                { ja: "Yatta ne, Aaron-kun!", vi: "LÃ m Ä‘Æ°á»£c rá»“i nhÃ© Aaron!" },
                { ja: "Subarashii desu, Aaron-kun!", vi: "Tháº­t tuyá»‡t vá»i, Aaron!" },
                { ja: "Sono choushi desu, Aaron-kun!", vi: "Cá»© giá»¯ phong Ä‘á»™ nÃ y nhÃ© Aaron!" },
                { ja: "Aaron-kun wa tensai kamo?", vi: "Aaron lÃ  thiÃªn tÃ i chÄƒng?" },
                { ja: "Rem wa ureshii desu, Aaron-kun!", vi: "Rem vui láº¯m, Aaron Æ¡i!" },
                { ja: "Kirei na hatsuon desu ne.", vi: "PhÃ¡t Ã¢m hay quÃ¡." },
                { ja: "Motto homete agemasu, Aaron-kun!", vi: "Rem sáº½ khen Aaron nhiá»u hÆ¡n!" },
                { ja: "Onigakkari desu ne!", vi: "Quá»· hÃ³a tháº§n sáº§u luÃ´n!" },
                { ja: "Aaron-kun, daisuki desu!", vi: "Aaron, mÃ¬nh thÃ­ch láº¯m (cÃ¢u tráº£ lá»i Ä‘Ã³)!" } 
            ],
            wrong: [
                { ja: "Zannen... Aaron-kun.", vi: "Tiáº¿c quÃ¡ Aaron Æ¡i..." },
                { ja: "Mou ichido ganbatte, Aaron-kun!", vi: "Cá»‘ gáº¯ng thá»­ láº¡i nÃ o Aaron!" },
                { ja: "Akiramenaide kudasai, Aaron-kun.", vi: "Xin Ä‘á»«ng bá» cuá»™c, Aaron." },
                { ja: "Daijoubu desu yo, Aaron-kun.", vi: "KhÃ´ng sao Ä‘Ã¢u mÃ  Aaron." },
                { ja: "Tsugi wa kitto dekimasu.", vi: "Láº§n sau cháº¯c cháº¯n lÃ m Ä‘Æ°á»£c." },
                { ja: "Donmai, Aaron-kun!", vi: "Äá»«ng báº­n tÃ¢m, Aaron!" },
                { ja: "Rem ga tsuiteimasu kara.", vi: "VÃ¬ cÃ³ Rem á»Ÿ Ä‘Ã¢y vá»›i Aaron mÃ ." },
                { ja: "Aseranaide kudasai, Aaron-kun.", vi: "Äá»«ng vá»™i vÃ ng nhÃ© Aaron." }
            ],
            finish: [
                { ja: "Otsukaresama deshita, Aaron-kun!", vi: "Aaron Ä‘Ã£ váº¥t váº£ rá»“i!" },
                { ja: "Kanpeki desu, Aaron-kun!", vi: "HoÃ n háº£o, Aaron!" },
                { ja: "Yoku dekimashita.", vi: "Aaron lÃ m tá»‘t láº¯m." },
                { ja: "Aaron-kun no doryoku ni kandou shimashita.", vi: "Rem cáº£m Ä‘á»™ng trÆ°á»›c ná»— lá»±c cá»§a Aaron." },
                { ja: "Suteki na jikan deshita, Aaron-kun.", vi: "Tháº­t lÃ  má»™t khoáº£ng thá»i gian tuyá»‡t vá»i vá»›i Aaron." }
            ],
            idle: [
                { ja: "Aaron-kun, nete imasu ka?", vi: "Aaron Ä‘ang ngá»§ Ã ?" },
                { ja: "Rem wa sabishii desu...", vi: "Rem tháº¥y cÃ´ Ä‘Æ¡n..." },
                { ja: "Mada desu ka, Aaron-kun?", vi: "Váº«n chÆ°a xong sao Aaron?" },
                { ja: "Asobimashou, Aaron-kun!", vi: "CÃ¹ng há»c tiáº¿p nÃ o Aaron!" },
                { ja: "Aaron-kun, Rem no koto wasurenaide.", vi: "Aaron Ä‘á»«ng quÃªn Rem nhÃ©." },
                { ja: "Ne~e sama ni iitsukemasu yo?", vi: "Rem mÃ¡ch chá»‹ hai Ä‘Ã³ nha?" },
                { ja: "Aaron-kun to motto hanashitai desu.", vi: "Muá»‘n nÃ³i chuyá»‡n vá»›i Aaron nhiá»u hÆ¡n." }
            ],
            switchTab: [
                { ja: "Atarashii chousen desu ne, Aaron-kun.", vi: "Thá»­ thÃ¡ch má»›i cho Aaron nhá»‰." },
                { ja: "Ganbatte kudasai, Aaron-kun.", vi: "HÃ£y cá»‘ gáº¯ng lÃªn, Aaron." },
                { ja: "Kibun tenkan desu ka?", vi: "Thay Ä‘á»•i khÃ´ng khÃ­ chÃºt nhÃ©?" },
                { ja: "Tsugi wa nani o shimashou ka?", vi: "Tiáº¿p theo mÃ¬nh lÃ m gÃ¬ Ä‘Ã¢y Aaron?" },
                { ja: "Doko e ittemo, Rem wa tsuiteikimasu.", vi: "DÃ¹ Aaron Ä‘i Ä‘Ã¢u, Rem cÅ©ng Ä‘i theo." },
                { ja: "Aaron-kun, isogi suginaide.", vi: "Aaron Ä‘á»«ng vá»™i quÃ¡ nhÃ©." },
                { ja: "Betsu no moudo desu ne. Tanoshimimashou.", vi: "Cháº¿ Ä‘á»™ khÃ¡c nhá»‰. CÃ¹ng vui nhÃ© Aaron." },
                { ja: "Chotto yasumimasu ka? Ie, mada desu ne.", vi: "Nghá»‰ chÃºt khÃ´ng? Ã€ khÃ´ng, chÆ°a nhá»‰." },
                { ja: "Rem wa itsudemo soba ni imasu.", vi: "Rem luÃ´n á»Ÿ bÃªn cáº¡nh Aaron." },
                { ja: "Yoshi, ikimashou Aaron-kun!", vi: "ÄÆ°á»£c rá»“i, Ä‘i thÃ´i Aaron!" },
                { ja: "Kono moudo mo omoshirosou desu.", vi: "Cháº¿ Ä‘á»™ nÃ y trÃ´ng cÅ©ng thÃº vá»‹ Ä‘áº¥y." }
            ]
        };
        
        let remTimeout;
        let idleTimer;
        let typeWriterTimeouts = [];
        let recentQuotes = [];
        const MAX_HISTORY = 5;
        
        // TOGGLE STATE
        let isRemActive = true;

        function toggleRemChat() {
            isRemActive = !isRemActive;
            const btn = document.getElementById('btn-toggle-chat');
            const icon = btn.querySelector('i');
            const text = document.getElementById('chat-status-text');
            const avatar = document.getElementById('rem-avatar-container');

            if (isRemActive) {
                icon.className = 'fas fa-comment-dots';
                btn.className = "flex items-center gap-1 hover:text-blue-500 transition-colors text-blue-500";
                text.innerText = "Báº­t Chat";
                avatar.classList.remove('disabled');
                showRemChat("Rem modotte kimashita!", "Rem Ä‘Ã£ quay láº¡i rá»“i Ä‘Ã¢y!", 3000);
                resetIdleTimer();
            } else {
                icon.className = 'fas fa-comment-slash';
                btn.className = "flex items-center gap-1 hover:text-blue-500 transition-colors text-gray-400";
                text.innerText = "Táº¯t Chat";
                avatar.classList.add('disabled');
                
                // Hide existing bubble
                const bubble = document.getElementById('rem-bubble');
                if(bubble) bubble.classList.remove('show');
                
                // Stop speaking
                if ('speechSynthesis' in window) window.speechSynthesis.cancel();
                
                // Clear timers
                if (remTimeout) clearTimeout(remTimeout);
                if (idleTimer) clearTimeout(idleTimer);
            }
        }

        // FIXED: Extra Soft Volume (0.25)
        function playRemVoice(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                
                const voices = window.speechSynthesis.getVoices();
                let jaVoice = voices.find(v => v.name.includes("Google") && v.lang.includes("ja"));
                if (!jaVoice) {
                     jaVoice = voices.find(v => v.lang === 'ja-JP' || v.lang === 'ja_JP');
                }
                
                if (jaVoice) utterance.voice = jaVoice;

                utterance.lang = 'ja-JP';
                utterance.rate = 1.05; 
                utterance.pitch = 1.1; 
                utterance.volume = 0.25; // WHISPER MODE
                window.speechSynthesis.speak(utterance);
            }
        }

        function typeWriter(elementId, text, speed = 50) { 
            const element = document.getElementById(elementId);
            if (!element) return;
            element.innerHTML = '';
            let i = 0;
            
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    const timeout = setTimeout(type, speed);
                    typeWriterTimeouts.push(timeout);
                }
            }
            type();
        }

        function showRemChat(jaText, viText, duration = 5000) {
            if (!isRemActive) return; // Guard clause for toggle

            const bubble = document.getElementById('rem-bubble');
            const subContainer = document.getElementById('sub-text-container');
            const cursorVi = document.getElementById('cursor-vi');
            
            if(!bubble) return;
            
            typeWriterTimeouts.forEach(t => clearTimeout(t));
            typeWriterTimeouts = [];
            
            bubble.classList.add('show');
            subContainer.style.display = 'block';
            cursorVi.style.display = 'inline-block';

            typeWriter('typewriter-vi', viText, 50); 
            
            setTimeout(() => {
                typeWriter('typewriter-ja', jaText, 40);
            }, 300);
            
            playRemVoice(jaText);
            
            if (remTimeout) clearTimeout(remTimeout);
            remTimeout = setTimeout(() => {
                bubble.classList.remove('show');
                cursorVi.style.display = 'none';
            }, duration);
        }

        function speakRem(type) {
            if (!isRemActive) return;

            const msgs = remQuotes[type] || remQuotes.welcome;
            const availableMsgs = msgs.filter(m => !recentQuotes.includes(m.ja));
            const source = availableMsgs.length > 0 ? availableMsgs : msgs;
            const msg = source[Math.floor(Math.random() * source.length)];
            
            recentQuotes.push(msg.ja);
            if (recentQuotes.length > MAX_HISTORY) {
                recentQuotes.shift();
            }
            
            showRemChat(msg.ja, msg.vi);
        }
        
        function triggerRemTalk() {
            // Manual trigger works even if disabled? No, let's respect the toggle.
            // If user wants to force talk, they should enable it first.
            // OR we can allow manual override. Let's allow manual override but keep toggle off.
            // Wait, previous request implied toggle controls "chat bot".
            // Let's make manual trigger FORCE a message even if off, but keep auto-triggers off.
            
            const categories = ['welcome', 'correct', 'finish', 'idle'];
            const randomCat = categories[Math.floor(Math.random() * categories.length)];
            
            // Allow one-time override logic
            if (!isRemActive) {
                // If off, just show bubble briefly without changing global state?
                // Actually safer to require ON.
                // Let's check state.
                const btn = document.getElementById('btn-toggle-chat');
                btn.click(); // Auto turn on if clicked manually
                return;
            }
            
            speakRem(randomCat);
        }

        function resetIdleTimer() {
            if (!isRemActive) return;
            if(idleTimer) clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                speakRem('idle');
            }, 30000); 
        }

        // --- APP STATE ---
        let currentTab = 'flashcard';
        let fcList = [...vocabularyData];
        let fcIndex = 0;
        let fcShuffled = false;

        let quizList = [];
        let quizIndex = 0;
        let quizScore = 0;
        let quizMode = 'ja_to_vi';
        let currentQuizItem = null;

        let writeList = [];
        let writeIndex = 0;
        let writeDirection = 'vi_to_ja';
        let writeInputType = 'romaji';
        let writeState = 'waiting';

        let matchCards = [];
        let selectedCards = [];
        let matchedPairs = 0;
        let matchTimer = null;
        let matchSeconds = 0;

        // --- INIT ---
        window.onload = function() {
            window.speechSynthesis.getVoices(); 
            renderFlashcard();
            renderList();
            
            if (isRemActive) {
                const hour = new Date().getHours();
                if (hour < 12) showRemChat("Ohayou gozaimasu, Aaron-kun!", "ChÃ o buá»•i sÃ¡ng, Aaron!");
                else if (hour > 18) showRemChat("Konbanwa, Aaron-kun!", "ChÃ o buá»•i tá»‘i, Aaron!");
                else speakRem('welcome');
                
                resetIdleTimer();
                document.addEventListener('mousemove', resetIdleTimer);
                document.addEventListener('keydown', resetIdleTimer);
                document.addEventListener('click', resetIdleTimer);
            }
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if(btn.dataset.tab === tabId) {
                    btn.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50/50');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-800', 'hover:bg-white/50');
                } else {
                    btn.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50/50');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-800', 'hover:bg-white/50');
                }
            });

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            currentTab = tabId;

            if(tabId === 'quiz') initQuiz();
            if(tabId === 'write') initWrite();
            if(tabId === 'match') {
                if(matchSeconds === 0 && matchedPairs === 0) initMatchGame();
            }
            
            speakRem('switchTab');
        }

        // --- FLASHCARD LOGIC ---
        function renderFlashcard() {
            const item = fcList[fcIndex];
            document.getElementById('fc-counter').innerText = `${fcIndex + 1} / ${fcList.length}`;
            document.getElementById('fc-japanese').innerHTML = item.japanese; // Use innerHTML for ruby
            document.getElementById('fc-romaji').innerText = item.romaji;
            document.getElementById('fc-vietnamese').innerText = item.vietnamese;
            document.getElementById('card-inner').classList.remove('rotate-y-180');
        }
        function flipCard() {
            document.getElementById('card-inner').classList.toggle('rotate-y-180');
        }
        function nextCard() {
            fcIndex = (fcIndex + 1) % fcList.length;
            renderFlashcard();
        }
        function prevCard() {
            fcIndex = (fcIndex - 1 + fcList.length) % fcList.length;
            renderFlashcard();
        }
        function toggleShuffle() {
            fcShuffled = !fcShuffled;
            const btn = document.getElementById('btn-shuffle');
            if(fcShuffled) {
                fcList = shuffleArray([...vocabularyData]);
                btn.classList.add('bg-blue-600', 'text-white', 'border-transparent');
                btn.classList.remove('bg-white', 'text-slate-500', 'border-slate-200');
                btn.innerHTML = `<i class="fas fa-random"></i> <span>Trá»™n</span>`;
                showRemChat("Mazemaze shimashita!", "ÄÃ£ trá»™n Ä‘á»u rá»“i!");
            } else {
                fcList = [...vocabularyData];
                btn.classList.remove('bg-blue-600', 'text-white', 'border-transparent');
                btn.classList.add('bg-white', 'text-slate-500', 'border-slate-200');
                btn.innerHTML = `<i class="fas fa-sort-numeric-down"></i> <span>Gá»‘c</span>`;
                showRemChat("Motodouri desu.", "Vá» nhÆ° cÅ© rá»“i.");
            }
            fcIndex = 0;
            renderFlashcard();
        }
        function playAudioFromCard(e) {
            e.stopPropagation();
            playAudio(fcList[fcIndex].reading);
        }

        // --- QUIZ LOGIC ---
        function changeQuizMode(mode) {
            quizMode = mode;
            initQuiz();
            showRemChat("Moudo o kaemashita.", "ÄÃ£ Ä‘á»•i cháº¿ Ä‘á»™.");
        }
        function initQuiz() {
            quizList = shuffleArray([...vocabularyData]).slice(0, 10);
            quizIndex = 0;
            quizScore = 0;
            document.getElementById('quiz-result').classList.add('hidden');
            document.getElementById('quiz-game').classList.remove('hidden');
            renderQuiz();
        }
        function renderQuiz() {
            if(quizIndex >= quizList.length) {
                showQuizResult();
                return;
            }
            const item = quizList[quizIndex];
            currentQuizItem = item;
            document.getElementById('quiz-current-idx').innerText = quizIndex + 1;
            document.getElementById('quiz-bar').style.width = `${((quizIndex) / quizList.length) * 100}%`;
            
            let isQuestionJa = true;
            if (quizMode === 'vi_to_ja') isQuestionJa = false;
            else if (quizMode === 'mixed') isQuestionJa = Math.random() < 0.5;

            const qMain = document.getElementById('quiz-question-main');
            const qSub = document.getElementById('quiz-question-sub');
            const audioBtn = document.getElementById('quiz-audio-btn');

            if (isQuestionJa) {
                qMain.innerHTML = item.japanese; // HTML for Ruby
                qSub.innerText = item.romaji;
                qSub.classList.remove('hidden');
                audioBtn.classList.remove('hidden');
            } else {
                qMain.innerText = item.vietnamese;
                qSub.classList.add('hidden');
                audioBtn.classList.add('hidden');
            }
            
            let options = shuffleArray([...vocabularyData]).filter(x => x.id !== item.id).slice(0, 3);
            options.push(item);
            options = shuffleArray(options);

            const container = document.getElementById('quiz-options');
            container.innerHTML = '';
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full p-4 text-left bg-white border-2 border-slate-100 rounded-xl hover:border-blue-400 hover:bg-blue-50 transition-all font-medium text-slate-700 flex items-center shadow-sm";
                const optText = isQuestionJa ? opt.vietnamese : opt.japanese; // HTML if Japanese
                btn.innerHTML = `<span class="flex-grow">${optText}</span>`;
                btn.onclick = () => checkQuiz(btn, opt.id === item.id);
                container.appendChild(btn);
            });
        }
        function checkQuiz(btn, isCorrect) {
            const btns = document.getElementById('quiz-options').children;
            for(let b of btns) b.disabled = true;

            if(isCorrect) {
                btn.classList.remove('border-slate-100', 'text-slate-700');
                btn.classList.add('bg-green-50', 'border-green-500', 'text-green-700');
                btn.innerHTML += `<i class="fas fa-check-circle text-green-600 text-xl ml-2"></i>`;
                quizScore++;
                playAudio(currentQuizItem.reading);
                speakRem('correct');
            } else {
                btn.classList.remove('border-slate-100', 'text-slate-700');
                btn.classList.add('bg-red-50', 'border-red-500', 'text-red-700');
                btn.innerHTML += `<i class="fas fa-times-circle text-red-600 text-xl ml-2"></i>`;
                speakRem('wrong');
                
                let isQuestionJa = (document.getElementById('quiz-question-sub').classList.contains('hidden')) === false; 
                const correctText = isQuestionJa ? currentQuizItem.vietnamese : currentQuizItem.japanese;
                for(let b of btns) {
                    if(b.innerHTML.includes(correctText)) {
                        b.classList.add('bg-green-50', 'border-green-300', 'text-green-700');
                    }
                }
            }
            setTimeout(() => {
                quizIndex++;
                renderQuiz();
            }, 1500);
        }
        function showQuizResult() {
            document.getElementById('quiz-game').classList.add('hidden');
            document.getElementById('quiz-result').classList.remove('hidden');
            document.getElementById('quiz-score').innerText = quizScore;
            document.getElementById('quiz-total').innerText = quizList.length;
            speakRem('finish');
        }
        function playAudioCurrentQuiz() {
            if(currentQuizItem) playAudio(currentQuizItem.reading);
        }

        // --- WRITE LOGIC ---
        function setWriteDirection(val) {
            writeDirection = val;
            initWrite();
        }
        function setWriteInputType(type) {
            writeInputType = type;
            if(type === 'romaji') {
                document.getElementById('mode-romaji').classList = "px-3 py-1 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm border border-slate-100";
                document.getElementById('mode-japanese').classList = "px-3 py-1 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
            } else {
                document.getElementById('mode-japanese').classList = "px-3 py-1 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm border border-slate-100";
                document.getElementById('mode-romaji').classList = "px-3 py-1 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
            }
            renderWrite();
        }
        function initWrite() {
            writeList = shuffleArray([...vocabularyData]);
            writeIndex = 0;
            renderWrite();
        }
        function renderWrite() {
            if(writeIndex >= writeList.length) {
                writeList = shuffleArray([...vocabularyData]);
                writeIndex = 0;
                showRemChat("Isshuu shimashita!", "ÄÃ£ xong má»™t vÃ²ng!");
            }
            const item = writeList[writeIndex];
            
            let targetIsJa = true;
            if (writeDirection === 'ja_to_vi') targetIsJa = false;
            else if (writeDirection === 'mixed') targetIsJa = Math.random() < 0.5;

            const label = document.getElementById('write-label');
            const question = document.getElementById('write-question');
            const hint = document.getElementById('write-hint');
            const tip = document.getElementById('write-tip');
            const inputTypeSelector = document.getElementById('write-input-type-selector');
            const input = document.getElementById('write-input');

            document.getElementById('view-write').dataset.targetIsJa = targetIsJa;

            if (targetIsJa) {
                label.innerText = "Dá»‹ch sang Tiáº¿ng Nháº­t";
                question.innerText = item.vietnamese;
                // BUG FIX: Show full HTML Ruby as hint if Romaji mode (so user knows which word), or simple reading if Japanese mode
                if(writeInputType === 'romaji') {
                    hint.innerHTML = item.japanese; 
                } else {
                    hint.innerHTML = item.reading;
                }
                
                tip.classList.remove('hidden');
                inputTypeSelector.classList.remove('hidden');
                input.placeholder = writeInputType === 'romaji' ? "Nháº­p Romaji (vd: watashi)" : "Nháº­p Kana/Kanji";
            } else {
                label.innerText = "Dá»‹ch sang Tiáº¿ng Viá»‡t";
                question.innerHTML = item.japanese; 
                hint.innerText = item.vietnamese;
                tip.classList.add('hidden');
                inputTypeSelector.classList.add('hidden');
                input.placeholder = "Nháº­p nghÄ©a tiáº¿ng Viá»‡t...";
            }
            hint.style.opacity = '0';
            input.value = '';
            input.disabled = false;
            input.className = "w-full p-5 text-xl font-bold text-center bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:bg-white transition-all placeholder-slate-300 text-slate-700";
            input.focus();
            document.getElementById('write-feedback').innerHTML = '';
            const btn = document.getElementById('write-btn');
            btn.innerText = "Kiá»ƒm tra";
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-blue-200');
            btn.classList.remove('bg-slate-700', 'hover:bg-slate-800', 'shadow-slate-200');
            writeState = 'waiting';
        }
        function toggleHint() {
            const h = document.getElementById('write-hint');
            h.style.opacity = h.style.opacity === '0' ? '1' : '0';
        }
        function checkWriteAnswer() {
            if(writeState !== 'waiting') {
                writeIndex++;
                renderWrite();
                return;
            }
            const input = document.getElementById('write-input').value.trim();
            if(!input) return;
            const item = writeList[writeIndex];
            const targetIsJa = document.getElementById('view-write').dataset.targetIsJa === 'true';
            let correct = false;

            if (targetIsJa) {
                if(writeInputType === 'romaji') {
                    const normalize = (s) => s.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const cleanInput = normalize(input);
                    const target1 = normalize(item.romaji.normalize("NFD").replace(/[\u0300-\u036f]/g, ""));
                    const target2 = normalize(item.romaji.replace(/Ä/g, 'aa').replace(/Å/g, 'oo').replace(/Å«/g, 'uu'));
                    const target3 = normalize(item.romaji.replace(/Å/g, 'ou'));
                    if(cleanInput === target1 || cleanInput === target2 || cleanInput === target3) correct = true;
                } else {
                    const cleanInput = input.replace(/\s+/g, '');
                    const cleanTargetReading = item.reading.replace(/[ï¼ˆï¼‰()]/g, '');
                    // BUG FIX: Use getCleanText helper to strip ruby tags for comparison
                    const cleanTargetKanji = getCleanText(item.japanese).replace(/[ï¼ˆï¼‰()]/g, '');
                    
                    if(cleanInput === cleanTargetReading || cleanInput === cleanTargetKanji) correct = true;
                }
            } else {
                const cleanInput = input.toLowerCase().trim();
                const meaningParts = item.vietnamese.toLowerCase().split(/[\/(),]+/).map(s => s.trim()).filter(s => s.length > 0);
                if (meaningParts.includes(cleanInput)) correct = true;
                if (item.vietnamese.toLowerCase() === cleanInput) correct = true;
            }

            const feedback = document.getElementById('write-feedback');
            const inp = document.getElementById('write-input');
            const btn = document.getElementById('write-btn');

            if(correct) {
                const answerText = targetIsJa ? item.japanese : item.vietnamese;
                feedback.innerHTML = `<div class="text-green-600 font-bold bg-green-50 px-4 py-2 rounded-xl flex items-center justify-center gap-2 animate-bounce w-full border border-green-100 shadow-sm"><i class="fas fa-check-circle"></i> ChÃ­nh xÃ¡c! ${answerText}</div>`;
                inp.classList.add('border-green-400', 'bg-green-50');
                if (targetIsJa) playAudio(item.reading);
                speakRem('correct');
            } else {
                const answerText = targetIsJa ? `${item.japanese} (${item.romaji})` : item.vietnamese;
                feedback.innerHTML = `<div class="text-red-600 font-bold bg-red-50 px-4 py-2 rounded-xl text-center w-full border border-red-100 shadow-sm"><i class="fas fa-times-circle"></i> Sai rá»“i.<br><span class="text-sm font-normal text-slate-600">ÄÃ¡p Ã¡n: ${answerText}</span></div>`;
                inp.classList.add('border-red-400', 'bg-red-50');
                speakRem('wrong');
            }
            inp.focus(); 
            writeState = 'finished';
            btn.innerText = "Tiáº¿p tá»¥c (Enter)";
            btn.classList.add('bg-slate-700', 'hover:bg-slate-800', 'shadow-slate-200');
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-blue-200');
        }
        document.getElementById('write-input').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') { e.preventDefault(); checkWriteAnswer(); }
        });

        // --- MATCH GAME LOGIC ---
        function initMatchGame() {
            const grid = document.getElementById('match-grid');
            grid.innerHTML = '';
            matchCards = [];
            selectedCards = [];
            matchedPairs = 0;
            if(matchTimer) clearInterval(matchTimer);
            matchSeconds = 0;
            document.getElementById('match-timer').innerText = "00:00";
            matchTimer = setInterval(() => {
                matchSeconds++;
                const m = Math.floor(matchSeconds / 60).toString().padStart(2, '0');
                const s = (matchSeconds % 60).toString().padStart(2, '0');
                document.getElementById('match-timer').innerText = `${m}:${s}`;
            }, 1000);

            const subset = shuffleArray([...vocabularyData]).slice(0, 8);
            subset.forEach((item, idx) => {
                // For Japanese side, show HTML (Kanji+Furigana). 
                // We need to store reading for audio.
                matchCards.push({ id: idx, type: 'ja', text: item.japanese, reading: item.reading, ref: item });
                matchCards.push({ id: idx, type: 'vi', text: item.vietnamese, reading: null, ref: item });
            });
            matchCards = shuffleArray(matchCards);

            matchCards.forEach((card, domIdx) => {
                const el = document.createElement('div');
                el.className = "match-card bg-white rounded-xl shadow-sm border-2 border-slate-100 flex items-center justify-center p-2 text-center text-sm md:text-base font-bold text-slate-700 h-24 hover:border-blue-300 hover:shadow-md active:bg-blue-50";
                
                // Allow HTML rendering for Ruby
                if(card.type === 'ja') {
                     el.innerHTML = card.text;
                } else {
                     el.innerText = card.text;
                }

                if(card.text.length > 20) el.classList.add('text-xs');
                
                el.onclick = () => handleMatchClick(el, card);
                grid.appendChild(el);
            });
        }
        function handleMatchClick(el, card) {
            if(el.classList.contains('matched') || el.classList.contains('selected') || selectedCards.length >= 2) return;
            if(card.type === 'ja') playAudio(card.reading);

            el.classList.add('selected');
            selectedCards.push({ el, card });

            if(selectedCards.length === 2) {
                const [c1, c2] = selectedCards;
                if(c1.card.id === c2.card.id) {
                    setTimeout(() => {
                        c1.el.classList.remove('selected'); c2.el.classList.remove('selected');
                        c1.el.classList.add('matched'); c2.el.classList.add('matched');
                        matchedPairs++;
                        speakRem('correct');
                        if(matchedPairs === 8) {
                            clearInterval(matchTimer);
                            speakRem('finish');
                            alert(`HoÃ n thÃ nh! Thá»i gian: ${document.getElementById('match-timer').innerText}`);
                        }
                    }, 400);
                } else {
                    c1.el.classList.add('wrong'); c2.el.classList.add('wrong');
                    speakRem('wrong');
                    setTimeout(() => {
                        c1.el.classList.remove('selected', 'wrong');
                        c2.el.classList.remove('selected', 'wrong');
                    }, 800);
                }
                selectedCards = [];
            }
        }

        // --- LIST LOGIC ---
        function renderList() {
            const tbody = document.getElementById('list-table-body');
            vocabularyData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors group";
                tr.innerHTML = `
                    <td class="p-4 border-b border-slate-100 font-mono text-blue-500 font-bold group-hover:text-blue-600">${item.romaji}</td>
                    <td class="p-4 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2 text-lg">
                        ${item.japanese}
                        <button onclick="playAudio('${item.reading}')" class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:bg-blue-500 hover:text-white transition-all flex items-center justify-center text-xs opacity-0 group-hover:opacity-100">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </td>
                    <td class="p-4 border-b border-slate-100 text-slate-600 font-medium">${item.vietnamese}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
