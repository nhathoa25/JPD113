<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Ti·∫øng Nh·∫≠t c√πng Rem - B√†i 3: L·ªãch Tr√¨nh (Dekiru Nihongo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Quicksand:wght@500;600;700&display=swap');
        
        body {
            font-family: 'Quicksand', 'Noto Sans JP', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#dbeafe 1px, transparent 1px);
            background-size: 20px 20px;
            overscroll-behavior-y: contain; 
        }

        /* 3D Flip Animation */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Rem Avatar */
        .rem-avatar-container {
            position: relative;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            z-index: 50;
        }
        .rem-avatar-container:hover {
            transform: scale(1.05);
        }
        .rem-avatar-container:active {
            transform: scale(0.95);
        }
        .rem-glow {
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.6);
            border-color: #93c5fd;
        }
        .rem-avatar-container.disabled {
            filter: grayscale(0.8) opacity(0.7);
        }
        
        /* Camera Icon Overlay on Hover */
        .rem-avatar-container .upload-overlay {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .rem-avatar-container:hover .upload-overlay {
            opacity: 1;
        }

        /* Advanced Rem Chat Bubble */
        .rem-bubble-wrapper {
            position: absolute;
            top: 5px;
            left: 75px;
            z-index: 40;
            pointer-events: none;
            filter: drop-shadow(0 4px 6px rgba(37, 99, 235, 0.15));
        }

        .rem-bubble {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            border: 1px solid #bfdbfe;
            border-radius: 18px;
            border-top-left-radius: 2px;
            padding: 12px 20px;
            min-width: 240px;
            max-width: 340px;
            opacity: 0;
            transform-origin: top left;
            transform: scale(0) rotate(-10deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .rem-bubble.show {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            animation: floatBubble 3s ease-in-out infinite;
        }

        @keyframes floatBubble {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .rem-text-main {
            font-size: 0.95rem;
            color: #1e3a8a;
            font-weight: 700;
            line-height: 1.4;
        }
        
        .rem-text-sub {
            font-size: 0.8rem;
            color: #3b82f6;
            font-weight: 600;
            border-top: 1px solid #e0f2fe;
            padding-top: 4px;
            margin-top: 2px;
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* Typewriter Cursor */
        .cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: #3b82f6;
            margin-left: 2px;
            animation: blink 1s step-end infinite;
            vertical-align: middle;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Mobile adjustment */
        @media (max-width: 640px) {
            .rem-bubble-wrapper {
                top: 65px;
                left: 10px;
            }
            .rem-bubble {
                border-top-left-radius: 18px;
                border-top-right-radius: 2px;
            }
        }

        .match-card {
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        .match-card.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
            transform: scale(1.05);
            box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.4);
        }
        .match-card.matched {
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }
        .match-card.wrong {
            background-color: #ef4444;
            color: white;
            animation: shake 0.4s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .input-focus-ring:focus-within {
            box-shadow: 0 0 0 4px rgba(147, 197, 253, 0.5);
            border-color: #60a5fa;
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col pb-20">

    <!-- HEADER -->
    <header class="bg-white/80 backdrop-blur-md border-b border-blue-100 sticky top-0 z-30 shadow-sm select-none">
        <div class="max-w-5xl mx-auto px-4 h-20 py-2 flex items-center justify-between relative">
            <div class="flex items-center gap-4 relative">
                <!-- Rem Avatar - CLICK TO CHANGE IMAGE -->
                <div id="rem-avatar-container" class="rem-avatar-container w-16 h-16 rounded-full overflow-hidden border-4 border-white rem-glow bg-blue-50 flex-shrink-0 group" onclick="document.getElementById('avatar-upload').click()" title="Ch·∫°m ƒë·ªÉ ƒë·ªïi ·∫£nh">
                    <!-- Default Rem Image -->
                    <img id="rem-avatar-img"
                         src="../download.jpg"
                         alt="Rem"
                         class="w-full h-full object-cover">
                    
                    <!-- Overlay Icon -->
                    <div class="upload-overlay absolute inset-0 bg-black/30 flex items-center justify-center">
                        <i class="fas fa-camera text-white text-xl"></i>
                    </div>
                    
                    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="changeAvatar(this)">
                </div>

                <!-- Talk Button (Manual Trigger) -->
                <button onclick="triggerRemTalk()" class="absolute -bottom-2 left-10 bg-blue-500 hover:bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-md z-50 border-2 border-white transition-transform hover:scale-110" title="Rem n√≥i chuy·ªán ngay">
                    <i class="fas fa-comment-dots text-xs"></i>
                </button>

                <!-- REM CHAT BUBBLE -->
                <div class="rem-bubble-wrapper">
                    <div id="rem-bubble" class="rem-bubble">
                        <div class="rem-text-main">
                            <span id="typewriter-vi"></span><span class="cursor" id="cursor-vi"></span>
                        </div>
                        <div class="rem-text-sub" id="sub-text-container" style="display: none;">
                            <span id="typewriter-ja"></span>
                        </div>
                    </div>
                </div>

                <div class="ml-2 pt-1 flex flex-col justify-center">
                    <h1 class="text-xl font-bold text-slate-800 hidden sm:block tracking-tight">H·ªçc c√πng Rem</h1>
                    <h1 class="text-lg font-bold text-slate-800 sm:hidden">Dekiru B√†i 3</h1>
                    
                    <!-- CONTROLS ROW -->
                    <div class="flex items-center gap-3 text-xs font-bold text-slate-500 mt-1">
                        <button onclick="document.getElementById('avatar-upload').click()" class="flex items-center gap-1 hover:text-blue-500 transition-colors">
                            <i class="fas fa-camera"></i> <span class="hidden sm:inline">ƒê·ªïi ·∫£nh</span>
                        </button>
                        <span class="text-slate-300">|</span>
                        <button onclick="toggleRemChat()" id="btn-toggle-chat" class="flex items-center gap-1 hover:text-blue-500 transition-colors text-blue-500">
                            <i class="fas fa-comment-dots"></i> <span id="chat-status-text">B·∫≠t Chat</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="hidden sm:flex flex-col items-end">
                <span class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Ti·∫øn ƒë·ªô</span>
                <span class="text-sm font-bold text-blue-600" id="global-progress">0%</span>
            </div>
        </div>

        <!-- TABS NAV -->
        <div class="max-w-5xl mx-auto px-4 overflow-x-auto no-scrollbar bg-white/50 backdrop-blur-sm border-b border-blue-50">
            <div class="flex gap-2 sm:gap-6 border-b border-transparent min-w-max sm:min-w-0" id="tab-container">
                <button onclick="switchTab('flashcard')" class="tab-btn active flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-blue-500 text-blue-600 bg-blue-50/50" data-tab="flashcard">
                    <i class="fas fa-clone"></i> <span class="hidden sm:inline">Flashcard</span><span class="sm:hidden">Th·∫ª</span>
                </button>
                <button onclick="switchTab('quiz')" class="tab-btn flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-transparent text-gray-500 hover:text-gray-800 hover:bg-white/50" data-tab="quiz">
                    <i class="fas fa-question-circle"></i> <span class="hidden sm:inline">Tr·∫Øc nghi·ªám</span><span class="sm:hidden">Quiz</span>
                </button>
                <button onclick="switchTab('write')" class="tab-btn flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-transparent text-gray-500 hover:text-gray-800 hover:bg-white/50" data-tab="write">
                    <i class="fas fa-keyboard"></i> <span class="hidden sm:inline">G√µ t·ª´</span><span class="sm:hidden">G√µ</span>
                </button>
                <button onclick="switchTab('match')" class="tab-btn flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-transparent text-gray-500 hover:text-gray-800 hover:bg-white/50" data-tab="match">
                    <i class="fas fa-puzzle-piece"></i> <span class="hidden sm:inline">Gh√©p th·∫ª</span><span class="sm:hidden">Gh√©p</span>
                </button>
                <button onclick="switchTab('list')" class="tab-btn flex-1 sm:flex-none flex items-center justify-center gap-2 py-3 px-3 border-b-2 font-bold text-sm transition-all whitespace-nowrap border-transparent text-gray-500 hover:text-gray-800 hover:bg-white/50" data-tab="list">
                    <i class="fas fa-list"></i> <span class="hidden sm:inline">Danh s√°ch</span><span class="sm:hidden">List</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-5xl mx-auto px-4 py-6 w-full flex-grow relative" onclick="resetIdleTimer()">
        
        <!-- 1. FLASHCARD MODE -->
        <div id="view-flashcard" class="view-section fade-in">
            <div class="flex flex-col items-center justify-center max-w-2xl mx-auto">
                <div class="w-full flex justify-between items-center mb-4 px-2">
                    <span class="text-slate-500 font-bold text-sm bg-white px-4 py-1.5 rounded-full shadow-sm border border-blue-100" id="fc-counter">1 / 88</span>
                    <button onclick="toggleShuffle()" id="btn-shuffle" class="flex items-center gap-2 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider transition-all bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-500 shadow-sm">
                        <i class="fas fa-random"></i> <span>G·ªëc</span>
                    </button>
                </div>

                <div class="relative w-full aspect-[16/10] sm:aspect-[16/9] cursor-pointer perspective-1000 group" onclick="flipCard()">
                    <div id="card-inner" class="relative w-full h-full duration-500 preserve-3d transition-transform">
                        <!-- Front -->
                        <div class="absolute w-full h-full backface-hidden bg-white border border-blue-100 rounded-3xl shadow-[0_10px_40px_-10px_rgba(59,130,246,0.15)] flex flex-col items-center justify-center p-6 text-center hover:shadow-[0_20px_50px_-10px_rgba(59,130,246,0.25)] transition-shadow">
                            <span class="text-xs text-blue-500 font-extrabold tracking-widest uppercase mb-4 bg-blue-50 px-3 py-1 rounded-lg">Ti·∫øng Nh·∫≠t</span>
                            <div class="flex flex-col items-center justify-center gap-4 mb-2 w-full flex-grow">
                                <h2 class="text-4xl sm:text-6xl font-black text-slate-800 tracking-tight" id="fc-japanese">...</h2>
                                <button onclick="playAudioFromCard(event)" class="w-12 h-12 rounded-full bg-blue-50 text-blue-500 hover:bg-blue-500 hover:text-white transition-all shadow-sm flex items-center justify-center transform hover:scale-110 active:scale-95" title="Nghe ph√°t √¢m">
                                    <i class="fas fa-volume-up text-lg"></i>
                                </button>
                            </div>
                            <p class="text-xl text-slate-400 font-medium italic mb-8 font-serif" id="fc-romaji">...</p>
                            <div class="absolute bottom-6 text-xs text-blue-300 flex items-center gap-2 font-bold animate-pulse">
                                <i class="fas fa-sync-alt"></i> Ch·∫°m ƒë·ªÉ l·∫≠t
                            </div>
                        </div>

                        <!-- Back -->
                        <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-blue-500 to-indigo-600 rounded-3xl shadow-xl flex flex-col items-center justify-center p-6 text-center rotate-y-180 text-white">
                            <span class="text-xs text-blue-100 font-extrabold tracking-widest uppercase mb-4 bg-white/10 px-3 py-1 rounded-lg backdrop-blur-sm">Ti·∫øng Vi·ªát</span>
                            <h2 class="text-2xl sm:text-4xl font-bold leading-relaxed flex-grow flex items-center justify-center drop-shadow-md" id="fc-vietnamese">
                                ...
                            </h2>
                            <button onclick="playAudioFromCard(event)" class="mt-4 px-6 py-2.5 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur-md text-white transition-all flex items-center gap-2 text-sm font-bold shadow-inner">
                                <i class="fas fa-volume-up"></i> Nghe l·∫°i
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4 mt-8 w-full max-w-sm">
                    <button onclick="prevCard()" class="flex-1 py-4 rounded-2xl bg-white border border-slate-200 shadow-sm hover:bg-slate-50 hover:border-blue-300 text-slate-600 transition-all active:scale-95 flex items-center justify-center group">
                        <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                    </button>
                    <button onclick="nextCard()" class="flex-1 py-4 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 shadow-lg shadow-blue-200 hover:shadow-blue-300 hover:to-blue-500 text-white transition-all active:scale-95 flex items-center justify-center group font-bold">
                         Ti·∫øp theo <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. QUIZ MODE -->
        <div id="view-quiz" class="view-section hidden fade-in">
            <div id="quiz-container" class="max-w-2xl mx-auto">
                <div id="quiz-config" class="mb-4 flex justify-end">
                    <div class="inline-flex bg-white rounded-xl border border-slate-200 p-1.5 shadow-sm">
                        <select id="quiz-mode-select" onchange="changeQuizMode(this.value)" class="text-xs font-bold text-slate-600 bg-transparent outline-none cursor-pointer py-1 px-2">
                            <option value="ja_to_vi">üáØüáµ Nh·∫≠t ‚ûú üáªüá≥ Vi·ªát</option>
                            <option value="vi_to_ja">üáªüá≥ Vi·ªát ‚ûú üáØüáµ Nh·∫≠t</option>
                            <option value="mixed">üîÄ Tr·ªôn l·∫´n</option>
                        </select>
                    </div>
                </div>

                <div id="quiz-result" class="hidden flex flex-col items-center justify-center py-10 text-center">
                    <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-500 text-5xl mb-6 shadow-inner animate-bounce">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Ho√†n th√†nh!</h2>
                    <p class="text-slate-500 mb-6 font-medium">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng:</p>
                    <div class="text-6xl font-black text-blue-600 mb-8 tracking-tighter">
                        <span id="quiz-score">0</span><span class="text-2xl text-slate-300 font-normal mx-2">/</span><span id="quiz-total" class="text-2xl text-slate-400 font-normal">0</span>
                    </div>
                    <button onclick="initQuiz()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 transform hover:-translate-y-1">
                        <i class="fas fa-redo mr-2"></i> Th·ª≠ l·∫°i
                    </button>
                </div>

                <div id="quiz-game">
                    <div class="flex justify-between items-end mb-6">
                        <span class="text-xs font-extrabold text-blue-600 uppercase tracking-wider bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">C√¢u h·ªèi <span id="quiz-current-idx">1</span></span>
                        <div class="flex gap-1 h-2.5 w-32 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                            <div id="quiz-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-3xl shadow-lg border border-slate-100 mb-6 text-center relative overflow-hidden min-h-[180px] flex flex-col items-center justify-center">
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400"></div>
                        <h3 class="text-3xl md:text-5xl font-black text-slate-800 mb-3" id="quiz-question-main">...</h3>
                        <p class="text-slate-400 font-medium italic mb-2" id="quiz-question-sub">...</p>
                        <button id="quiz-audio-btn" onclick="playAudioCurrentQuiz()" class="mx-auto w-10 h-10 rounded-full bg-slate-50 text-slate-400 hover:bg-blue-100 hover:text-blue-600 transition-all flex items-center justify-center hidden mt-2">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-3" id="quiz-options">
                        <!-- Options injected via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. WRITE MODE (OPTIMIZED) -->
        <div id="view-write" class="view-section hidden fade-in">
            <div class="max-w-xl mx-auto mt-4">
                <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-slate-100 text-center relative">
                    <div class="flex justify-between items-center mb-8">
                         <div class="inline-flex bg-slate-50 p-1.5 rounded-xl border border-slate-100">
                            <select id="write-direction" onchange="setWriteDirection(this.value)" class="text-xs font-bold text-slate-600 bg-transparent outline-none cursor-pointer py-1 px-2">
                                <option value="vi_to_ja">üáªüá≥ Vi·ªát ‚ûú üáØüáµ Nh·∫≠t</option>
                                <option value="ja_to_vi">üáØüáµ Nh·∫≠t ‚ûú üáªüá≥ Vi·ªát</option>
                                <option value="mixed">üîÄ Tr·ªôn l·∫´n</option>
                            </select>
                        </div>
                        <div id="write-input-type-selector" class="flex bg-slate-50 p-1 rounded-xl border border-slate-100">
                            <button onclick="setWriteInputType('romaji')" id="mode-romaji" class="px-3 py-1 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm border border-slate-100">Romaji</button>
                            <button onclick="setWriteInputType('japanese')" id="mode-japanese" class="px-3 py-1 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600">Kana</button>
                        </div>
                    </div>

                    <div class="mb-8">
                        <p class="text-xs text-blue-400 font-extrabold tracking-widest uppercase mb-3" id="write-label">D·ªãch sang ti·∫øng Nh·∫≠t</p>
                        <h3 class="text-3xl md:text-4xl font-black text-slate-800" id="write-question">...</h3>
                        <div id="write-hint" class="h-6 mt-3 text-blue-500 font-bold opacity-0 transition-opacity">...</div>
                    </div>

                    <div class="relative group input-focus-ring rounded-2xl mb-4">
                        <input type="text" id="write-input" 
                            class="w-full p-5 text-xl font-bold text-center bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:bg-white transition-all placeholder-slate-300 text-slate-700" 
                            placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." autocomplete="off">
                        <button onclick="toggleHint()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-yellow-400 transition-colors" title="Xem g·ª£i √Ω">
                            <i class="fas fa-lightbulb"></i>
                        </button>
                    </div>

                    <div id="write-feedback" class="min-h-[4rem] flex items-center justify-center text-sm md:text-base mb-2"></div>

                    <button id="write-btn" onclick="checkWriteAnswer()" class="w-full mt-2 py-4 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all transform active:scale-[0.98]">
                        Ki·ªÉm tra (Enter)
                    </button>
                    
                    <p class="mt-6 text-xs text-slate-400 font-medium bg-slate-50 inline-block px-3 py-1 rounded-full border border-slate-100" id="write-tip">
                        <i class="fas fa-info-circle mr-1 text-blue-400"></i> M·∫πo: G√µ <span class="font-mono text-slate-600">aa</span> thay <span class="font-mono text-slate-600">ƒÅ</span>, <span class="font-mono text-slate-600">ou</span> thay <span class="font-mono text-slate-600">≈ç</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- 4. MATCH GAME MODE -->
        <div id="view-match" class="view-section hidden fade-in h-full flex flex-col">
            <div class="max-w-4xl mx-auto w-full h-full flex flex-col">
                <div class="flex justify-between items-center mb-6 px-2">
                    <div class="flex items-center gap-3 text-slate-700 font-bold bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm">
                        <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-500">
                            <i class="fas fa-stopwatch"></i>
                        </div>
                        <span id="match-timer" class="font-mono text-lg">00:00</span>
                    </div>
                    <button onclick="initMatchGame()" class="text-sm font-bold text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-xl transition-colors border border-transparent hover:border-blue-100">
                        <i class="fas fa-redo mr-1"></i> Ch∆°i l·∫°i
                    </button>
                </div>
                
                <div id="match-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 pb-8"></div>
            </div>
        </div>

        <!-- 5. LIST MODE -->
        <div id="view-list" class="view-section hidden fade-in">
            <div class="max-w-4xl mx-auto mt-4 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="p-4 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-1/4">Romaji</th>
                                <th class="p-4 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-1/4">Ti·∫øng Nh·∫≠t</th>
                                <th class="p-4 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-1/2">Nghƒ©a ti·∫øng Vi·ªát</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50 text-sm" id="list-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- JS LOGIC -->
    <script>
        // --- DATA FROM PDF: Dekiru Nihongo - Lesson 3 (Schedule) ---
        // Updated with full vocabulary, including sentences and questions, and Kanji replaced by Hiragana/Katakana
        const vocabularyData = [
            { id: 1, japanese: '„Åó„ÇÖ„ÅÜ„Åæ„Å§', romaji: 'sh≈´matsu', vietnamese: 'Cu·ªëi tu·∫ßn' },
            { id: 2, japanese: '„ÅÑ„Åæ', romaji: 'ima', vietnamese: 'B√¢y gi·ªù' },
            { id: 3, japanese: '„Åî„Åú„Çì', romaji: 'gozen', vietnamese: 'Bu·ªïi s√°ng (AM)' },
            { id: 4, japanese: '„Åî„Åî', romaji: 'gogo', vietnamese: 'Bu·ªïi chi·ªÅu (PM)' },
            { id: 5, japanese: '„Å≤„Çã', romaji: 'hiru', vietnamese: 'Bu·ªïi tr∆∞a' },
            { id: 6, japanese: '„Åé„Çì„Åì„ÅÜ', romaji: 'gink≈ç', vietnamese: 'Ng√¢n h√†ng' },
            { id: 7, japanese: '„Åü„ÅÑ„ÅÑ„Åè„Åã„Çì', romaji: 'taiikukan', vietnamese: 'Nh√† ch∆°i th·ªÉ thao' },
            { id: 8, japanese: '„Å®„Åó„Çá„Åã„Çì', romaji: 'toshokan', vietnamese: 'Th∆∞ vi·ªán' },
            { id: 9, japanese: '„Å≥„Çá„ÅÜ„ÅÑ„Çì', romaji: 'by≈çin', vietnamese: 'B·ªánh vi·ªán' },
            { id: 10, japanese: '„ÇÜ„ÅÜ„Å≥„Çì„Åç„Çá„Åè', romaji: 'y≈´binkyoku', vietnamese: 'B∆∞u ƒëi·ªán' },
            { id: 11, japanese: '„Åò„ÇÖ„Åé„Çá„ÅÜ', romaji: 'jugy≈ç', vietnamese: 'Gi·ªù h·ªçc' },
            { id: 12, japanese: '„ÉÜ„Çπ„Éà', romaji: 'tesuto', vietnamese: 'B√†i ki·ªÉm tra' },
            { id: 13, japanese: '„ÇÑ„Åô„Åø', romaji: 'yasumi', vietnamese: 'Gi·ªù ngh·ªâ' },
            { id: 14, japanese: '„Åò„Åã„Çì', romaji: 'jikan', vietnamese: 'Th·ªùi gian' },
            { id: 15, japanese: 'ÔΩû„Åò', romaji: '~ji', vietnamese: '~ gi·ªù' },
            { id: 16, japanese: 'ÔΩû„Åµ„Çì', romaji: '~fun', vietnamese: '~ ph√∫t' },
            { id: 17, japanese: '„ÅÑ„Åæ„ÄÅ9„Åò20„Å∑„Çì„Åß„Åô„ÄÇ', romaji: 'Ima, 9-ji 20-pun desu', vietnamese: 'B√¢y gi·ªù l√† 9 gi·ªù 20 ph√∫t.' },
            { id: 18, japanese: 'ÔΩû„Åò„ÅØ„Çì', romaji: '~jihan', vietnamese: '~ gi·ªù r∆∞·ª°i' },
            { id: 19, japanese: 'ÔΩû„Çà„ÅÜ„Å≥', romaji: '~y≈çbi', vietnamese: 'Th·ª© ~' },
            { id: 20, japanese: '„Çπ„Ç±„Ç∏„É•„Éº„É´', romaji: 'sukej≈´ru', vietnamese: 'L·ªãch l√†m vi·ªác' },
            { id: 21, japanese: '„Ç¢„É´„Éê„Ç§„Éà', romaji: 'arubaito', vietnamese: 'Vi·ªác l√†m th√™m' },
            { id: 22, japanese: '„Çπ„Ç≠„Éº', romaji: 'sukƒ´', vietnamese: 'Tr∆∞·ª£t tuy·∫øt' },
            { id: 23, japanese: '„Éë„Éº„ÉÜ„Ç£„Éº', romaji: 'pƒÅtƒ´', vietnamese: 'B·ªØa ti·ªác' },
            { id: 24, japanese: '„Éê„Éº„Éô„Ç≠„É•„Éº', romaji: 'bƒÅbeky≈´', vietnamese: 'B·ªØa ti·ªác th·ªãt n∆∞·ªõng' },
            { id: 25, japanese: '„ÅØ„Å™„Å≥', romaji: 'hanabi', vietnamese: 'Ph√°o hoa' },
            { id: 26, japanese: '(„Åä)„ÅØ„Å™„Åø', romaji: '(o)hanami', vietnamese: 'Ng·∫Øm hoa' },
            { id: 27, japanese: '„Éõ„Éº„É†„Çπ„ÉÜ„Ç§', romaji: 'h≈çmusutei', vietnamese: 'Nh√† tr·ªç ng∆∞·ªùi b·∫£n x·ª©' },
            { id: 28, japanese: '(„Åä)„Åæ„Å§„Çä', romaji: '(o)matsuri', vietnamese: 'L·ªÖ h·ªôi' },
            { id: 29, japanese: '„ÅÜ„Åø', romaji: 'umi', vietnamese: 'Bi·ªÉn' },
            { id: 30, japanese: '„Åì„ÅÜ„Åà„Çì', romaji: 'k≈çen', vietnamese: 'C√¥ng vi√™n' },
            { id: 31, japanese: '„Åï„Åè„Çâ', romaji: 'sakura', vietnamese: 'Hoa anh ƒë√†o' },
            { id: 32, japanese: '(„Åä)„Åï„Åë', romaji: '(o)sake', vietnamese: 'R∆∞·ª£u' },
            { id: 33, japanese: '(„Åä)„Åô„Åó', romaji: '(o)sushi', vietnamese: 'Sushi' },
            { id: 34, japanese: '„Éê„Çπ', romaji: 'basu', vietnamese: 'Xe bu√Ωt' },
            { id: 35, japanese: '(„Åä)„Åπ„Çì„Å®„ÅÜ', romaji: '(o)bent≈ç', vietnamese: 'C∆°m h·ªôp' },
            { id: 36, japanese: '„Çä„ÇÖ„ÅÜ„Åå„Åè„Åõ„ÅÑ', romaji: 'ry≈´gakusei', vietnamese: 'Du h·ªçc sinh' },
            { id: 37, japanese: '1„Å≠„Çì', romaji: '1-nen', vietnamese: 'NƒÉm th·ª© nh·∫•t' },
            { id: 38, japanese: '„ÅØ„Çã', romaji: 'haru', vietnamese: 'M√πa xu√¢n' },
            { id: 39, japanese: '„Å™„Å§', romaji: 'natsu', vietnamese: 'M√πa h√®' },
            { id: 40, japanese: '„ÅÇ„Åç', romaji: 'aki', vietnamese: 'M√πa thu' },
            { id: 41, japanese: '„Åµ„ÇÜ', romaji: 'fuyu', vietnamese: 'M√πa ƒë√¥ng' },
            { id: 42, japanese: '„Ç¥„Éº„É´„Éá„É≥„Ç¶„Ç£„Éº„ÇØ', romaji: 'g≈çrudenwƒ´ku', vietnamese: 'Tu·∫ßn l·ªÖ v√†ng' },
            { id: 43, japanese: '„Å™„Å´', romaji: 'nani', vietnamese: 'C√°i g√¨' },
            { id: 44, japanese: '„ÅÑ„Åç„Åæ„Åô', romaji: 'ikimasu', vietnamese: 'ƒêi' },
            { id: 45, japanese: '„Åã„Åà„Çä„Åæ„Åô', romaji: 'kaerimasu', vietnamese: 'V·ªÅ' },
            { id: 46, japanese: '„ÅÆ„Åø„Åæ„Åô', romaji: 'nomimasu', vietnamese: 'U·ªëng' },
            { id: 47, japanese: '„Åü„Åπ„Åæ„Åô', romaji: 'tabemasu', vietnamese: 'ƒÇn' },
            { id: 48, japanese: '„Åø„Åæ„Åô', romaji: 'mimasu', vietnamese: 'Xem' },
            { id: 49, japanese: '„Åó„Åæ„Åô', romaji: 'shimasu', vietnamese: 'L√†m' },
            { id: 50, japanese: '„Çπ„Ç≠„Éº„Çí„Åó„Åæ„Åô„ÄÇ', romaji: 'sukƒ´ o shimasu', vietnamese: 'Tr∆∞·ª£t tuy·∫øt' },
            { id: 51, japanese: '„ÅÑ„ÅÑ„Åß„Åô„Å≠', romaji: 'ii desu ne', vietnamese: 'Th√≠ch nh·ªâ' },
            { id: 52, japanese: 'A: „Å™„Å§„ÇÑ„Åô„Åø„ÄÅ„Åª„Å£„Åã„ÅÑ„Å©„ÅÜ„Å∏„ÅÑ„Åç„Åæ„Åô„ÄÇ B: „ÅÑ„ÅÑ„Åß„Åô„Å≠„ÄÇ', romaji: 'A: Natsuyasumi, Hokkaid≈ç e ikimasu. B: Ii desu ne.', vietnamese: 'A: Ngh·ªâ h√® t√¥i s·∫Ω ƒëi Hokkaido. B: Th√≠ch nh·ªâ.' },
            { id: 53, japanese: '„Åà„Å£', romaji: 'e\'', vietnamese: 'Sao' },
            { id: 54, japanese: '„Å∏„Åà', romaji: 'hƒì', vietnamese: '√Ä, th·∫ø √†' },
            { id: 55, japanese: '„ÅÇ„Åï', romaji: 'asa', vietnamese: 'Bu·ªïi s√°ng' },
            { id: 56, japanese: '„Çà„Çã', romaji: 'yoru', vietnamese: 'Bu·ªïi ƒë√™m' },
            { id: 57, japanese: '„Åæ„ÅÑ„Å´„Å°', romaji: 'mainichi', vietnamese: 'H√†ng ng√†y' },
            { id: 58, japanese: '„Åæ„ÅÑ„ÅÇ„Åï', romaji: 'maiasa', vietnamese: 'H√†ng s√°ng' },
            { id: 59, japanese: '„Åæ„ÅÑ„Å∞„Çì', romaji: 'maiban', vietnamese: 'H√†ng t·ªëi' },
            { id: 60, japanese: '„ÅÇ„Åï„Åî„ÅØ„Çì', romaji: 'asagohan', vietnamese: 'C∆°m s√°ng' },
            { id: 61, japanese: '„Å≤„Çã„Åî„ÅØ„Çì', romaji: 'hirugohan', vietnamese: 'C∆°m tr∆∞a' },
            { id: 62, japanese: '„ÅÜ„Å°', romaji: 'uchi', vietnamese: 'Nh√†' },
            { id: 63, japanese: '„Åã„ÅÑ„Åó„ÇÉ', romaji: 'kaisha', vietnamese: 'C√¥ng ty' },
            { id: 64, japanese: '„Åå„Å£„Åì„ÅÜ', romaji: 'gakk≈ç', vietnamese: 'Tr∆∞·ªùng h·ªçc' },
            { id: 65, japanese: '„Ç≥„É≥„Éì„Éã', romaji: 'konbini', vietnamese: 'C·ª≠a h√†ng ti·ªán l·ª£i' },
            { id: 66, japanese: '„Åé„ÇÖ„ÅÜ„Å´„ÇÖ„ÅÜ', romaji: 'gy≈´ny≈´', vietnamese: 'S·ªØa b√≤' },
            { id: 67, japanese: '„Åè„Å†„ÇÇ„ÅÆ', romaji: 'kudamono', vietnamese: 'Hoa qu·∫£' },
            { id: 68, japanese: '„Çµ„É©„ÉÄ', romaji: 'sarada', vietnamese: 'Salad' },
            { id: 69, japanese: '„ÉÅ„Éº„Ç∫', romaji: 'chƒ´zu', vietnamese: 'Ph√¥ mai' },
            { id: 70, japanese: '„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà', romaji: 'intƒÅnetto', vietnamese: 'Internet' },
            { id: 71, japanese: '„Åó„Çì„Å∂„Çì', romaji: 'shinbun', vietnamese: 'B√°o' },
            { id: 72, japanese: '„ÉÜ„É¨„Éì', romaji: 'terebi', vietnamese: 'Tivi' },
            { id: 73, japanese: 'CD', romaji: 'CD', vietnamese: 'CD' },
            { id: 74, japanese: 'DVD', romaji: 'DVD', vietnamese: 'DVD' },
            { id: 75, japanese: '„Å™„Å´„ÇÇ', romaji: 'nani mo', vietnamese: 'G√¨ c·∫£' },
            { id: 76, japanese: '„Å©„Åì(„Å∏)„ÇÇ', romaji: 'doko(e)mo', vietnamese: 'ƒê√¢u c·∫£' },
            { id: 77, japanese: '„Åã„ÅÑ„Åæ„Åô', romaji: 'kaimasu', vietnamese: 'Mua' },
            { id: 78, japanese: '„Åç„Åç„Åæ„Åô', romaji: 'kikimasu', vietnamese: 'Nghe' },
            { id: 79, japanese: 'CD„Çí„Åç„Åç„Åæ„Åô„ÄÇ', romaji: 'CD o kikimasu', vietnamese: 'Nghe ƒëƒ©a CD.' },
            { id: 80, japanese: '„ÅØ„Åü„Çâ„Åç„Åæ„Åô', romaji: 'hatarakimasu', vietnamese: 'L√†m vi·ªác' },
            { id: 81, japanese: '„Çà„Åø„Åæ„Åô', romaji: 'yomimasu', vietnamese: 'ƒê·ªçc' },
            { id: 82, japanese: '„Åä„Åç„Åæ„Åô', romaji: 'okimasu', vietnamese: 'D·∫≠y' },
            { id: 83, japanese: '„Å≠„Åæ„Åô', romaji: 'nemasu', vietnamese: 'Ng·ªß' },
            { id: 84, japanese: '„Åπ„Çì„Åç„Çá„ÅÜ„Éª„Åó„Åæ„Åô', romaji: 'benky≈ç shimasu', vietnamese: 'H·ªçc' },
            { id: 85, japanese: '„Åç„Åæ„Åô', romaji: 'kimasu', vietnamese: 'ƒê·∫øn' }
        ];

        // --- GLOBAL UTILS ---
        function playAudio(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const cleanText = text.replace(/[ÔºàÔºâ()]/g, '').replace(/ÔΩû/g, '');
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'ja-JP';
                utterance.rate = 1.0; 
                window.speechSynthesis.speak(utterance);
            }
        }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- CHANGE AVATAR ---
        function changeAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('rem-avatar-img').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- REM VOICE & CHAT LOGIC (V13 - Aaron Control) ---
        const remQuotes = {
            welcome: [
                { ja: "Aaron-kun, konnichiwa! Isshoni ganbarimashou!", vi: "Xin ch√†o Aaron! C√πng c·ªë g·∫Øng nh√©!" },
                { ja: "Rem wa Aaron-kun o matteimashita yo.", vi: "Rem ƒë√£ ƒë·ª£i Aaron ƒë√≥!" },
                { ja: "Aaron-kun, junbi wa ii desu ka?", vi: "Aaron ƒë√£ s·∫µn s√†ng ch∆∞a?" },
                { ja: "Kyou mo genki desu ne, Aaron-kun!", vi: "H√¥m nay Aaron c≈©ng kh·ªèe nh·ªâ!" },
                { ja: "Aaron-kun ni oaidekite ureshii desu.", vi: "R·∫•t vui ƒë∆∞·ª£c g·∫∑p Aaron." },
                { ja: "Ohayou gozaimasu, Aaron-kun!", vi: "Ch√†o bu·ªïi s√°ng, Aaron!" },
                { ja: "Konbanwa Aaron-kun, benkyou desu ka?", vi: "Ch√†o bu·ªïi t·ªëi Aaron, b·∫°n h·ªçc b√†i √†?" },
                { ja: "Aaron-kun no tame ni ganbarimasu.", vi: "Rem s·∫Ω c·ªë g·∫Øng v√¨ Aaron." },
                { ja: "Saa, hajimemashou, Aaron-kun.", vi: "N√†o, ch√∫ng ta b·∫Øt ƒë·∫ßu th√¥i, Aaron." }
            ],
            correct: [
                { ja: "Sugoi desu, Aaron-kun!", vi: "Aaron tuy·ªát qu√°!" },
                { ja: "Sasuga Aaron-kun desu ne!", vi: "Qu·∫£ l√† Aaron!" },
                { ja: "Seikai desu! Aaron-kun wa kashikoi desu.", vi: "Ch√≠nh x√°c! Aaron th√¥ng minh qu√°." },
                { ja: "Yatta ne, Aaron-kun!", vi: "L√†m ƒë∆∞·ª£c r·ªìi nh√© Aaron!" },
                { ja: "Subarashii desu, Aaron-kun!", vi: "Th·∫≠t tuy·ªát v·ªùi, Aaron!" },
                { ja: "Sono choushi desu, Aaron-kun!", vi: "C·ª© gi·ªØ phong ƒë·ªô n√†y nh√© Aaron!" },
                { ja: "Aaron-kun wa tensai kamo?", vi: "Aaron l√† thi√™n t√†i chƒÉng?" },
                { ja: "Rem wa ureshii desu, Aaron-kun!", vi: "Rem vui l·∫Øm, Aaron ∆°i!" },
                { ja: "Kirei na hatsuon desu ne.", vi: "Ph√°t √¢m hay qu√°." },
                { ja: "Motto homete agemasu, Aaron-kun!", vi: "Rem s·∫Ω khen Aaron nhi·ªÅu h∆°n!" },
                { ja: "Onigakkari desu ne!", vi: "Qu·ª∑ h√≥a th·∫ßn s·∫ßu lu√¥n!" },
                { ja: "Aaron-kun, daisuki desu!", vi: "Aaron, m√¨nh th√≠ch l·∫Øm (c√¢u tr·∫£ l·ªùi ƒë√≥)!" } 
            ],
            wrong: [
                { ja: "Zannen... Aaron-kun.", vi: "Ti·∫øc qu√° Aaron ∆°i..." },
                { ja: "Mou ichido ganbatte, Aaron-kun!", vi: "C·ªë g·∫Øng th·ª≠ l·∫°i n√†o Aaron!" },
                { ja: "Akiramenaide kudasai, Aaron-kun.", vi: "Xin ƒë·ª´ng b·ªè cu·ªôc, Aaron." },
                { ja: "Daijoubu desu yo, Aaron-kun.", vi: "Kh√¥ng sao ƒë√¢u m√† Aaron." },
                { ja: "Tsugi wa kitto dekimasu.", vi: "L·∫ßn sau ch·∫Øc ch·∫Øn l√†m ƒë∆∞·ª£c." },
                { ja: "Donmai, Aaron-kun!", vi: "ƒê·ª´ng b·∫≠n t√¢m, Aaron!" },
                { ja: "Rem ga tsuiteimasu kara.", vi: "V√¨ c√≥ Rem ·ªü ƒë√¢y v·ªõi Aaron m√†." },
                { ja: "Aseranaide kudasai, Aaron-kun.", vi: "ƒê·ª´ng v·ªôi v√†ng nh√© Aaron." }
            ],
            finish: [
                { ja: "Otsukaresama deshita, Aaron-kun!", vi: "Aaron ƒë√£ v·∫•t v·∫£ r·ªìi!" },
                { ja: "Kanpeki desu, Aaron-kun!", vi: "Ho√†n h·∫£o, Aaron!" },
                { ja: "Yoku dekimashita.", vi: "Aaron l√†m t·ªët l·∫Øm." },
                { ja: "Aaron-kun no doryoku ni kandou shimashita.", vi: "Rem c·∫£m ƒë·ªông tr∆∞·ªõc n·ªó l·ª±c c·ªßa Aaron." },
                { ja: "Suteki na jikan deshita, Aaron-kun.", vi: "Th·∫≠t l√† m·ªôt kho·∫£ng th·ªùi gian tuy·ªát v·ªùi v·ªõi Aaron." }
            ],
            idle: [
                { ja: "Aaron-kun, nete imasu ka?", vi: "Aaron ƒëang ng·ªß √†?" },
                { ja: "Rem wa sabishii desu...", vi: "Rem th·∫•y c√¥ ƒë∆°n..." },
                { ja: "Mada desu ka, Aaron-kun?", vi: "V·∫´n ch∆∞a xong sao Aaron?" },
                { ja: "Asobimashou, Aaron-kun!", vi: "C√πng h·ªçc ti·∫øp n√†o Aaron!" },
                { ja: "Aaron-kun, Rem no koto wasurenaide.", vi: "Aaron ƒë·ª´ng qu√™n Rem nh√©." },
                { ja: "Ne~e sama ni iitsukemasu yo?", vi: "Rem m√°ch ch·ªã hai ƒë√≥ nha?" },
                { ja: "Aaron-kun to motto hanashitai desu.", vi: "Mu·ªën n√≥i chuy·ªán v·ªõi Aaron nhi·ªÅu h∆°n." }
            ],
            switchTab: [
                { ja: "Atarashii chousen desu ne, Aaron-kun.", vi: "Th·ª≠ th√°ch m·ªõi cho Aaron nh·ªâ." },
                { ja: "Ganbatte kudasai, Aaron-kun.", vi: "H√£y c·ªë g·∫Øng l√™n, Aaron." },
                { ja: "Kibun tenkan desu ka?", vi: "Thay ƒë·ªïi kh√¥ng kh√≠ ch√∫t nh√©?" },
                { ja: "Tsugi wa nani o shimashou ka?", vi: "Ti·∫øp theo m√¨nh l√†m g√¨ ƒë√¢y Aaron?" },
                { ja: "Doko e ittemo, Rem wa tsuiteikimasu.", vi: "D√π Aaron ƒëi ƒë√¢u, Rem c≈©ng ƒëi theo." },
                { ja: "Aaron-kun, isogi suginaide.", vi: "Aaron ƒë·ª´ng v·ªôi qu√° nh√©." },
                { ja: "Betsu no moudo desu ne. Tanoshimimashou.", vi: "Ch·∫ø ƒë·ªô kh√°c nh·ªâ. C√πng vui nh√© Aaron." },
                { ja: "Chotto yasumimasu ka? Ie, mada desu ne.", vi: "Ngh·ªâ ch√∫t kh√¥ng? √Ä kh√¥ng, ch∆∞a nh·ªâ." },
                { ja: "Rem wa itsudemo soba ni imasu.", vi: "Rem lu√¥n ·ªü b√™n c·∫°nh Aaron." },
                { ja: "Yoshi, ikimashou Aaron-kun!", vi: "ƒê∆∞·ª£c r·ªìi, ƒëi th√¥i Aaron!" },
                { ja: "Kono moudo mo omoshirosou desu.", vi: "Ch·∫ø ƒë·ªô n√†y tr√¥ng c≈©ng th√∫ v·ªã ƒë·∫•y." }
            ]
        };
        
        let remTimeout;
        let idleTimer;
        let typeWriterTimeouts = [];
        let recentQuotes = [];
        const MAX_HISTORY = 5;
        
        // TOGGLE STATE
        let isRemActive = true;

        function toggleRemChat() {
            isRemActive = !isRemActive;
            const btn = document.getElementById('btn-toggle-chat');
            const icon = btn.querySelector('i');
            const text = document.getElementById('chat-status-text');
            const avatar = document.getElementById('rem-avatar-container');

            if (isRemActive) {
                icon.className = 'fas fa-comment-dots';
                btn.className = "flex items-center gap-1 hover:text-blue-500 transition-colors text-blue-500";
                text.innerText = "B·∫≠t Chat";
                avatar.classList.remove('disabled');
                showRemChat("Rem modotte kimashita!", "Rem ƒë√£ quay l·∫°i r·ªìi ƒë√¢y!", 3000);
                resetIdleTimer();
            } else {
                icon.className = 'fas fa-comment-slash';
                btn.className = "flex items-center gap-1 hover:text-blue-500 transition-colors text-gray-400";
                text.innerText = "T·∫Øt Chat";
                avatar.classList.add('disabled');
                
                // Hide existing bubble
                const bubble = document.getElementById('rem-bubble');
                if(bubble) bubble.classList.remove('show');
                
                // Stop speaking
                if ('speechSynthesis' in window) window.speechSynthesis.cancel();
                
                // Clear timers
                if (remTimeout) clearTimeout(remTimeout);
                if (idleTimer) clearTimeout(idleTimer);
            }
        }

        function playRemVoice(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                
                // --- PH·ª§C H·ªíI LOGIC CH·ªåN GI·ªåNG G·ªêC C·ª¶A B·∫†N (C√ì TH√äM PH·∫¶N KI·ªÇM TRA ƒê·ªÇ TR√ÅNH GI·ªåNG NAM N·∫æU C√ì TH·ªÇ) ---
                const voices = window.speechSynthesis.getVoices();
                // Logic g·ªëc c·ªßa b·∫°n ∆∞u ti√™n gi·ªçng Google tr∆∞·ªõc, r·ªìi ƒë·∫øn fallback chung
                // M√¨nh th√™m ƒëi·ªÅu ki·ªán check name kh√¥ng ch·ª©a "Ichiro" (gi·ªçng nam ƒëi·ªÉn h√¨nh) n·∫øu c√≥ th·ªÉ, nh∆∞ng b√°m s√°t code g·ªëc nh·∫•t l√† ∆∞u ti√™n Google.
                let jaVoice = voices.find(v => v.name.includes("Google") && v.lang.includes("ja"));
                if (!jaVoice) {
                      jaVoice = voices.find(v => v.lang === 'ja-JP' || v.lang === 'ja_JP');
                }
                
                if (jaVoice) utterance.voice = jaVoice;

                // --- KH√îI PH·ª§C C√ÅC TH√îNG S·ªê V·ªÄ ƒê√öNG CODE M·∫™U G·ªêC ---
                utterance.lang = 'ja-JP';
                utterance.rate = 1.05;  // T·ªëc ƒë·ªô h∆°i nhanh 1 ch√∫t (nh∆∞ code m·∫´u)
                utterance.pitch = 1.1;  // Cao ƒë·ªô nh·∫π nh√†ng (nh∆∞ code m·∫´u), kh√¥ng qu√° cao g√¢y r√®
                utterance.volume = 0.25; // QUAN TR·ªåNG: WHISPER MODE (√Çm l∆∞·ª£ng nh·ªè 25% nh∆∞ code m·∫´u)
                
                window.speechSynthesis.speak(utterance);
            }
        }

        function typeWriter(elementId, text, speed = 50) { 
            const element = document.getElementById(elementId);
            if (!element) return;
            element.innerHTML = '';
            let i = 0;
            
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    const timeout = setTimeout(type, speed);
                    typeWriterTimeouts.push(timeout);
                }
            }
            type();
        }

        function showRemChat(jaText, viText, duration = 5000) {
            if (!isRemActive) return; // Guard clause for toggle

            const bubble = document.getElementById('rem-bubble');
            const subContainer = document.getElementById('sub-text-container');
            const cursorVi = document.getElementById('cursor-vi');
            
            if(!bubble) return;
            
            typeWriterTimeouts.forEach(t => clearTimeout(t));
            typeWriterTimeouts = [];
            
            bubble.classList.add('show');
            subContainer.style.display = 'block';
            cursorVi.style.display = 'inline-block';

            typeWriter('typewriter-vi', viText, 50); 
            
            setTimeout(() => {
                typeWriter('typewriter-ja', jaText, 40);
            }, 300);
            
            playRemVoice(jaText);
            
            if (remTimeout) clearTimeout(remTimeout);
            remTimeout = setTimeout(() => {
                bubble.classList.remove('show');
                cursorVi.style.display = 'none';
            }, duration);
        }

        function speakRem(type) {
            if (!isRemActive) return;

            const msgs = remQuotes[type] || remQuotes.welcome;
            const availableMsgs = msgs.filter(m => !recentQuotes.includes(m.ja));
            const source = availableMsgs.length > 0 ? availableMsgs : msgs;
            const msg = source[Math.floor(Math.random() * source.length)];
            
            recentQuotes.push(msg.ja);
            if (recentQuotes.length > MAX_HISTORY) {
                recentQuotes.shift();
            }
            
            showRemChat(msg.ja, msg.vi);
        }
        
        function triggerRemTalk() {
            if (!isRemActive) {
                const btn = document.getElementById('btn-toggle-chat');
                btn.click(); // Auto turn on if clicked manually
                return;
            }
            const categories = ['welcome', 'correct', 'finish', 'idle'];
            const randomCat = categories[Math.floor(Math.random() * categories.length)];
            speakRem(randomCat);
        }

        function resetIdleTimer() {
            if (!isRemActive) return;
            if(idleTimer) clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                speakRem('idle');
            }, 30000); 
        }

        // --- APP STATE ---
        let currentTab = 'flashcard';
        let fcList = [...vocabularyData];
        let fcIndex = 0;
        let fcShuffled = false;

        let quizList = [];
        let quizIndex = 0;
        let quizScore = 0;
        let quizMode = 'ja_to_vi';
        let currentQuizItem = null;

        let writeList = [];
        let writeIndex = 0;
        let writeDirection = 'vi_to_ja';
        let writeInputType = 'romaji';
        let writeState = 'waiting';

        let matchCards = [];
        let selectedCards = [];
        let matchedPairs = 0;
        let matchTimer = null;
        let matchSeconds = 0;

        // --- INIT ---
        window.onload = function() {
            window.speechSynthesis.getVoices(); 
            renderFlashcard();
            renderList();
            
            if (isRemActive) {
                const hour = new Date().getHours();
                if (hour < 12) showRemChat("Ohayou gozaimasu, Aaron-kun!", "Ch√†o bu·ªïi s√°ng, Aaron!");
                else if (hour > 18) showRemChat("Konbanwa, Aaron-kun!", "Ch√†o bu·ªïi t·ªëi, Aaron!");
                else speakRem('welcome');
                
                resetIdleTimer();
                document.addEventListener('mousemove', resetIdleTimer);
                document.addEventListener('keydown', resetIdleTimer);
                document.addEventListener('click', resetIdleTimer);
            }
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if(btn.dataset.tab === tabId) {
                    btn.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50/50');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-800', 'hover:bg-white/50');
                } else {
                    btn.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50/50');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-800', 'hover:bg-white/50');
                }
            });

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            currentTab = tabId;

            if(tabId === 'quiz') initQuiz();
            if(tabId === 'write') initWrite();
            if(tabId === 'match') {
                if(matchSeconds === 0 && matchedPairs === 0) initMatchGame();
            }
            
            speakRem('switchTab');
        }

        // --- FLASHCARD LOGIC ---
        function renderFlashcard() {
            const item = fcList[fcIndex];
            document.getElementById('fc-counter').innerText = `${fcIndex + 1} / ${fcList.length}`;
            document.getElementById('fc-japanese').innerText = item.japanese;
            document.getElementById('fc-romaji').innerText = item.romaji;
            document.getElementById('fc-vietnamese').innerText = item.vietnamese;
            document.getElementById('card-inner').classList.remove('rotate-y-180');
        }
        function flipCard() {
            document.getElementById('card-inner').classList.toggle('rotate-y-180');
        }
        function nextCard() {
            fcIndex = (fcIndex + 1) % fcList.length;
            renderFlashcard();
        }
        function prevCard() {
            fcIndex = (fcIndex - 1 + fcList.length) % fcList.length;
            renderFlashcard();
        }
        function toggleShuffle() {
            fcShuffled = !fcShuffled;
            const btn = document.getElementById('btn-shuffle');
            if(fcShuffled) {
                fcList = shuffleArray([...vocabularyData]);
                btn.classList.add('bg-blue-600', 'text-white', 'border-transparent');
                btn.classList.remove('bg-white', 'text-slate-500', 'border-slate-200');
                btn.innerHTML = `<i class="fas fa-random"></i> <span>Tr·ªôn</span>`;
                showRemChat("Mazemaze shimashita!", "ƒê√£ tr·ªôn ƒë·ªÅu r·ªìi!");
            } else {
                fcList = [...vocabularyData];
                btn.classList.remove('bg-blue-600', 'text-white', 'border-transparent');
                btn.classList.add('bg-white', 'text-slate-500', 'border-slate-200');
                btn.innerHTML = `<i class="fas fa-sort-numeric-down"></i> <span>G·ªëc</span>`;
                showRemChat("Motodouri desu.", "V·ªÅ nh∆∞ c≈© r·ªìi.");
            }
            fcIndex = 0;
            renderFlashcard();
        }
        function playAudioFromCard(e) {
            e.stopPropagation();
            playAudio(fcList[fcIndex].japanese);
        }

        // --- QUIZ LOGIC ---
        function changeQuizMode(mode) {
            quizMode = mode;
            initQuiz();
            showRemChat("Moudo o kaemashita.", "ƒê√£ ƒë·ªïi ch·∫ø ƒë·ªô.");
        }
        function initQuiz() {
            quizList = shuffleArray([...vocabularyData]).slice(0, 10);
            quizIndex = 0;
            quizScore = 0;
            document.getElementById('quiz-result').classList.add('hidden');
            document.getElementById('quiz-game').classList.remove('hidden');
            renderQuiz();
        }
        function renderQuiz() {
            if(quizIndex >= quizList.length) {
                showQuizResult();
                return;
            }
            const item = quizList[quizIndex];
            currentQuizItem = item;
            document.getElementById('quiz-current-idx').innerText = quizIndex + 1;
            document.getElementById('quiz-bar').style.width = `${((quizIndex) / quizList.length) * 100}%`;
            
            let isQuestionJa = true;
            if (quizMode === 'vi_to_ja') isQuestionJa = false;
            else if (quizMode === 'mixed') isQuestionJa = Math.random() < 0.5;

            const qMain = document.getElementById('quiz-question-main');
            const qSub = document.getElementById('quiz-question-sub');
            const audioBtn = document.getElementById('quiz-audio-btn');

            if (isQuestionJa) {
                qMain.innerText = item.japanese;
                qSub.innerText = item.romaji;
                qSub.classList.remove('hidden');
                audioBtn.classList.remove('hidden');
            } else {
                qMain.innerText = item.vietnamese;
                qSub.classList.add('hidden');
                audioBtn.classList.add('hidden');
            }
            
            let options = shuffleArray([...vocabularyData]).filter(x => x.id !== item.id).slice(0, 3);
            options.push(item);
            options = shuffleArray(options);

            const container = document.getElementById('quiz-options');
            container.innerHTML = '';
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full p-4 text-left bg-white border-2 border-slate-100 rounded-xl hover:border-blue-400 hover:bg-blue-50 transition-all font-medium text-slate-700 flex items-center shadow-sm";
                const optText = isQuestionJa ? opt.vietnamese : opt.japanese;
                btn.innerHTML = `<span class="flex-grow">${optText}</span>`;
                btn.onclick = () => checkQuiz(btn, opt.id === item.id);
                container.appendChild(btn);
            });
        }
        function checkQuiz(btn, isCorrect) {
            const btns = document.getElementById('quiz-options').children;
            for(let b of btns) b.disabled = true;

            if(isCorrect) {
                btn.classList.remove('border-slate-100', 'text-slate-700');
                btn.classList.add('bg-green-50', 'border-green-500', 'text-green-700');
                btn.innerHTML += `<i class="fas fa-check-circle text-green-600 text-xl ml-2"></i>`;
                quizScore++;
                playAudio(currentQuizItem.japanese);
                speakRem('correct');
            } else {
                btn.classList.remove('border-slate-100', 'text-slate-700');
                btn.classList.add('bg-red-50', 'border-red-500', 'text-red-700');
                btn.innerHTML += `<i class="fas fa-times-circle text-red-600 text-xl ml-2"></i>`;
                speakRem('wrong');
                
                let isQuestionJa = (document.getElementById('quiz-question-sub').classList.contains('hidden')) === false; 
                const correctText = isQuestionJa ? currentQuizItem.vietnamese : currentQuizItem.japanese;
                for(let b of btns) {
                    if(b.innerText.includes(correctText)) {
                        b.classList.add('bg-green-50', 'border-green-300', 'text-green-700');
                    }
                }
            }
            setTimeout(() => {
                quizIndex++;
                renderQuiz();
            }, 1500);
        }
        function showQuizResult() {
            document.getElementById('quiz-game').classList.add('hidden');
            document.getElementById('quiz-result').classList.remove('hidden');
            document.getElementById('quiz-score').innerText = quizScore;
            document.getElementById('quiz-total').innerText = quizList.length;
            speakRem('finish');
        }
        function playAudioCurrentQuiz() {
            if(currentQuizItem) playAudio(currentQuizItem.japanese);
        }

        // --- WRITE LOGIC (OPTIMIZED) ---
        function setWriteDirection(val) {
            writeDirection = val;
            initWrite();
        }
        function setWriteInputType(type) {
            writeInputType = type;
            if(type === 'romaji') {
                document.getElementById('mode-romaji').classList = "px-3 py-1 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm border border-slate-100";
                document.getElementById('mode-japanese').classList = "px-3 py-1 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
            } else {
                document.getElementById('mode-japanese').classList = "px-3 py-1 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm border border-slate-100";
                document.getElementById('mode-romaji').classList = "px-3 py-1 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
            }
            renderWrite();
        }
        function initWrite() {
            writeList = shuffleArray([...vocabularyData]);
            writeIndex = 0;
            renderWrite();
        }
        function renderWrite() {
            if(writeIndex >= writeList.length) {
                writeList = shuffleArray([...vocabularyData]);
                writeIndex = 0;
                showRemChat("Isshuu shimashita!", "ƒê√£ xong m·ªôt v√≤ng!");
            }
            const item = writeList[writeIndex];
            
            let targetIsJa = true;
            if (writeDirection === 'ja_to_vi') targetIsJa = false;
            else if (writeDirection === 'mixed') targetIsJa = Math.random() < 0.5;

            const label = document.getElementById('write-label');
            const question = document.getElementById('write-question');
            const hint = document.getElementById('write-hint');
            const tip = document.getElementById('write-tip');
            const inputTypeSelector = document.getElementById('write-input-type-selector');
            const input = document.getElementById('write-input');

            document.getElementById('view-write').dataset.targetIsJa = targetIsJa;

            if (targetIsJa) {
                label.innerText = "D·ªãch sang Ti·∫øng Nh·∫≠t";
                question.innerText = item.vietnamese;
                hint.innerText = writeInputType === 'romaji' ? item.japanese : item.romaji;
                tip.classList.remove('hidden');
                inputTypeSelector.classList.remove('hidden');
                input.placeholder = writeInputType === 'romaji' ? "Nh·∫≠p Romaji (vd: watashi)" : "Nh·∫≠p Kana/Kanji";
            } else {
                label.innerText = "D·ªãch sang Ti·∫øng Vi·ªát";
                question.innerText = item.japanese; 
                hint.innerText = item.vietnamese;
                tip.classList.add('hidden');
                inputTypeSelector.classList.add('hidden');
                input.placeholder = "Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát...";
            }
            hint.style.opacity = '0';
            input.value = '';
            input.disabled = false;
            input.className = "w-full p-5 text-xl font-bold text-center bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:bg-white transition-all placeholder-slate-300 text-slate-700";
            input.focus();
            document.getElementById('write-feedback').innerHTML = '';
            const btn = document.getElementById('write-btn');
            btn.innerText = "Ki·ªÉm tra";
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-blue-200');
            btn.classList.remove('bg-slate-700', 'hover:bg-slate-800', 'shadow-slate-200');
            writeState = 'waiting';
        }
        function toggleHint() {
            const h = document.getElementById('write-hint');
            h.style.opacity = h.style.opacity === '0' ? '1' : '0';
        }
        
        // --- HELPER FOR FLEXIBLE GRADING ---
        function removeVietnameseTones(str) {
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g,"a"); 
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g,"e"); 
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g,"i"); 
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g,"o"); 
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g,"u"); 
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g,"y"); 
            str = str.replace(/ƒë/g,"d");
            // Normalize for composite chars
            str = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            return str;
        }

        function getPossibleAnswers(text) {
            const normalized = text.toLowerCase();
            let answers = new Set();
            
            // 1. Split by delimiters / , ;
            const parts = normalized.split(/[\/,;]+/).map(s => s.trim()).filter(s => s);
            
            parts.forEach(part => {
                answers.add(part); // Add full part "t√™n (l·ªãch s·ª±)"
                
                // 2. Handle Parentheses (abc) or ÔºàabcÔºâ
                if (part.match(/[Ôºà(].*?[)Ôºâ]/)) {
                    // Remove content inside parens: "t√™n (l·ªãch s·ª±)" -> "t√™n"
                    let clean = part.replace(/[Ôºà(].*?[)Ôºâ]/g, '').trim();
                    if (clean) answers.add(clean);
                    
                    // Keep content but remove parens symbols: "t√™n (l·ªãch s·ª±)" -> "t√™n l·ªãch s·ª±"
                    let noParens = part.replace(/[Ôºà()Ôºâ]/g, ' ').replace(/\s+/g, ' ').trim();
                    if (noParens) answers.add(noParens);
                }
                
                // 3. Handle Tilde ~
                if (part.includes('~') || part.includes('ÔΩû')) {
                    let noTilde = part.replace(/[~ÔΩû]/g, '').trim();
                    if (noTilde) answers.add(noTilde);
                }
            });
            return Array.from(answers);
        }

        function checkWriteAnswer() {
            if(writeState !== 'waiting') {
                writeIndex++;
                renderWrite();
                return;
            }
            const rawInput = document.getElementById('write-input').value.trim();
            if(!rawInput) return;
            
            const item = writeList[writeIndex];
            const targetIsJa = document.getElementById('view-write').dataset.targetIsJa === 'true';
            let correct = false;

            if (targetIsJa) {
                // VI -> JA
                if(writeInputType === 'romaji') {
                    // Normalize Input
                    const normalize = (s) => s.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const cleanInput = normalize(rawInput);
                    
                    // Create variants from Romaji (Handling long vowels)
                    const r = item.romaji;
                    const variants = [
                        normalize(r.normalize("NFD").replace(/[\u0300-\u036f]/g, "")), // ƒÅ -> a
                        normalize(r.replace(/ƒÅ/g, 'aa').replace(/≈ç/g, 'oo').replace(/≈´/g, 'uu')), // ƒÅ -> aa
                        normalize(r.replace(/≈ç/g, 'ou')), // ≈ç -> ou
                    ];
                    
                    // Also check parens logic for Romaji e.g. (o)namae -> namae, onamae
                    // Since my tokenizer handles strings, let's use it on romaji too
                    const possibleRomajis = getPossibleAnswers(item.romaji);
                    possibleRomajis.forEach(pr => {
                        variants.push(normalize(pr));
                        variants.push(normalize(pr.replace(/ƒÅ/g, 'aa')));
                    });

                    if (variants.some(v => v === cleanInput)) correct = true;
                } else {
                    // KANA Input
                    const cleanInput = rawInput.replace(/\s+/g, '');
                    const possibleKanas = getPossibleAnswers(item.japanese);
                    // Compare trimmed input against possible answers (e.g. input "„Åè„Å´" vs db "(„Åä)„Åè„Å´" -> "„Åè„Å´")
                    if (possibleKanas.some(pk => pk.replace(/\s+/g,'') === cleanInput)) correct = true;
                }
            } else {
                // JA -> VI (Meaning Check)
                const possibleVietnamese = getPossibleAnswers(item.vietnamese);
                const inputLower = rawInput.toLowerCase();
                const inputNoTone = removeVietnameseTones(inputLower);
                
                // Check 1: Exact match with flexible dictionary
                if (possibleVietnamese.includes(inputLower)) correct = true;
                
                // Check 2: Tone-less match (Optimized for lazy typing)
                if (!correct) {
                      const possibleNoTone = possibleVietnamese.map(v => removeVietnameseTones(v));
                      if (possibleNoTone.includes(inputNoTone)) correct = true;
                }
            }

            const feedback = document.getElementById('write-feedback');
            const inp = document.getElementById('write-input');
            const btn = document.getElementById('write-btn');

            if(correct) {
                const answerText = targetIsJa ? item.japanese : item.vietnamese;
                feedback.innerHTML = `<div class="text-green-600 font-bold bg-green-50 px-4 py-2 rounded-xl flex items-center justify-center gap-2 animate-bounce w-full border border-green-100 shadow-sm"><i class="fas fa-check-circle"></i> Ch√≠nh x√°c! ${answerText}</div>`;
                inp.classList.add('border-green-400', 'bg-green-50');
                if (targetIsJa) playAudio(item.japanese);
                speakRem('correct');
            } else {
                const answerText = targetIsJa ? `${item.japanese} (${item.romaji})` : item.vietnamese;
                feedback.innerHTML = `<div class="text-red-600 font-bold bg-red-50 px-4 py-2 rounded-xl text-center w-full border border-red-100 shadow-sm"><i class="fas fa-times-circle"></i> Sai r·ªìi.<br><span class="text-sm font-normal text-slate-600">ƒê√°p √°n: ${answerText}</span></div>`;
                inp.classList.add('border-red-400', 'bg-red-50');
                speakRem('wrong');
            }
            inp.focus(); 
            writeState = 'finished';
            btn.innerText = "Ti·∫øp t·ª•c (Enter)";
            btn.classList.add('bg-slate-700', 'hover:bg-slate-800', 'shadow-slate-200');
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-blue-200');
        }
        document.getElementById('write-input').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') { e.preventDefault(); checkWriteAnswer(); }
        });

        // --- MATCH GAME LOGIC ---
        function initMatchGame() {
            const grid = document.getElementById('match-grid');
            grid.innerHTML = '';
            matchCards = [];
            selectedCards = [];
            matchedPairs = 0;
            if(matchTimer) clearInterval(matchTimer);
            matchSeconds = 0;
            document.getElementById('match-timer').innerText = "00:00";
            matchTimer = setInterval(() => {
                matchSeconds++;
                const m = Math.floor(matchSeconds / 60).toString().padStart(2, '0');
                const s = (matchSeconds % 60).toString().padStart(2, '0');
                document.getElementById('match-timer').innerText = `${m}:${s}`;
            }, 1000);

            const subset = shuffleArray([...vocabularyData]).slice(0, 8);
            subset.forEach((item, idx) => {
                matchCards.push({ id: idx, type: 'ja', text: item.japanese, ref: item });
                matchCards.push({ id: idx, type: 'vi', text: item.vietnamese, ref: item });
            });
            matchCards = shuffleArray(matchCards);

            matchCards.forEach((card, domIdx) => {
                const el = document.createElement('div');
                el.className = "match-card bg-white rounded-xl shadow-sm border-2 border-slate-100 flex items-center justify-center p-2 text-center text-sm md:text-base font-bold text-slate-700 h-24 hover:border-blue-300 hover:shadow-md active:bg-blue-50";
                if(card.text.length > 20) el.classList.add('text-xs');
                el.innerText = card.text;
                el.onclick = () => handleMatchClick(el, card);
                grid.appendChild(el);
            });
        }
        function handleMatchClick(el, card) {
            if(el.classList.contains('matched') || el.classList.contains('selected') || selectedCards.length >= 2) return;
            if(card.type === 'ja') playAudio(card.text);

            el.classList.add('selected');
            selectedCards.push({ el, card });

            if(selectedCards.length === 2) {
                const [c1, c2] = selectedCards;
                if(c1.card.id === c2.card.id) {
                    setTimeout(() => {
                        c1.el.classList.remove('selected'); c2.el.classList.remove('selected');
                        c1.el.classList.add('matched'); c2.el.classList.add('matched');
                        matchedPairs++;
                        speakRem('correct');
                        if(matchedPairs === 8) {
                            clearInterval(matchTimer);
                            speakRem('finish');
                            alert(`Ho√†n th√†nh! Th·ªùi gian: ${document.getElementById('match-timer').innerText}`);
                        }
                    }, 400);
                } else {
                    c1.el.classList.add('wrong'); c2.el.classList.add('wrong');
                    speakRem('wrong');
                    setTimeout(() => {
                        c1.el.classList.remove('selected', 'wrong');
                        c2.el.classList.remove('selected', 'wrong');
                    }, 800);
                }
                selectedCards = [];
            }
        }

        // --- LIST LOGIC ---
        function renderList() {
            const tbody = document.getElementById('list-table-body');
            vocabularyData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors group";
                tr.innerHTML = `
                    <td class="p-4 border-b border-slate-100 font-mono text-blue-500 font-bold group-hover:text-blue-600">${item.romaji}</td>
                    <td class="p-4 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                        ${item.japanese}
                        <button onclick="playAudio('${item.japanese}')" class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:bg-blue-500 hover:text-white transition-all flex items-center justify-center text-xs opacity-0 group-hover:opacity-100">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </td>
                    <td class="p-4 border-b border-slate-100 text-slate-600 font-medium">${item.vietnamese}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
